import { useEffect, useState } from 'react';
import { init, useRawInitData } from '@telegram-apps/sdk-react';

// ─── Types ────────────────────────────────────────────────────────────────────
interface JournalEntry {
  id: string;
  date: string;
  text: string;
  day?: number;       // номер дня плана
  taskIdx?: number;   // 0, 1 или 2 — индекс задания внутри дня
}

interface DailyTask {
  id: string;
  text: string;
  done: boolean;
  priority: 'high' | 'medium' | 'low';
  time?: string;
}

interface WeeklyGoal {
  id: string;
  text: string;
  done: boolean;
}

interface UserState {
  theme: 'light' | 'dark';
  testDone: boolean;
  testScore: number;
  currentDay: number;
  completedDays: number[];
  journalEntries: JournalEntry[];
  lastCompletedDate: string | null;
  currentStreak: number;
  maxStreak: number;
  dailyTasks: DailyTask[];
  weeklyGoals: WeeklyGoal[];
}

const DEFAULT_STATE: UserState = {
  theme: 'light',
  testDone: false,
  testScore: 0,
  currentDay: 1,
  completedDays: [],
  journalEntries: [],
  lastCompletedDate: null,
  currentStreak: 0,
  maxStreak: 0,
  dailyTasks: [],
  weeklyGoals: [],
};

// ─── Helpers ──────────────────────────────────────────────────────────────────
function loadState(userId: string): UserState {
  try {
    const raw = localStorage.getItem(`userState_${userId}`);
    if (raw) {
      const parsed = JSON.parse(raw);
      const merged: UserState = { ...DEFAULT_STATE, ...parsed };

      // Миграция старого формата записей: dayTask → day, taskIdx = 0
      if (merged.journalEntries) {
        merged.journalEntries = merged.journalEntries.map((e: any) => {
          if (e.dayTask !== undefined && e.day === undefined) {
            return { ...e, day: e.dayTask, taskIdx: 0 };
          }
          return e;
        });
      }

      // Миграция стрика
      if (merged.completedDays.length > 0 && merged.currentStreak === 0 && merged.lastCompletedDate) {
        const today = getTodayString();
        const yesterday = getYesterdayString();
        if (merged.lastCompletedDate === today || merged.lastCompletedDate === yesterday) {
          merged.currentStreak = 1;
          merged.maxStreak = Math.max(merged.maxStreak, 1);
        }
      }

      return merged;
    }
  } catch {}
  return { ...DEFAULT_STATE };
}

function saveState(userId: string, state: UserState) {
  localStorage.setItem(`userState_${userId}`, JSON.stringify(state));
}

function getTodayString(): string {
  return new Date().toISOString().split('T')[0];
}

function getYesterdayString(): string {
  const d = new Date();
  d.setDate(d.getDate() - 1);
  return d.toISOString().split('T')[0];
}

function calcNewStreak(lastDate: string | null, currentStreak: number): number {
  if (!lastDate) return 1;
  const today = getTodayString();
  const yesterday = getYesterdayString();
  if (lastDate === today) return currentStreak;
  if (lastDate === yesterday) return currentStreak + 1;
  return 1;
}

// Проверяет, выполнено ли конкретное задание (есть ли запись)
function isTaskDone(entries: JournalEntry[], day: number, taskIdx: number): boolean {
  return entries.some(e => e.day === day && e.taskIdx === taskIdx);
}

// Сколько заданий выполнено в дне
function dayProgress(entries: JournalEntry[], day: number): number {
  return [0, 1, 2].filter(i => isTaskDone(entries, day, i)).length;
}

// ─── Тест ─────────────────────────────────────────────────────────────────────
const questions = [
  { q: 'Ты часто избегаешь конфликтов, чтобы никого не обидеть?', points: 2 },
  { q: 'Бывает, что ты делаешь что-то против своей воли, лишь бы тебя одобрили?', points: 2 },
  { q: 'Ты скрываешь свои настоящие чувства и желания от близких?', points: 2 },
  { q: 'Чувствуешь вину, если отказываешь кому-то в помощи?', points: 2 },
  { q: 'Ты часто ставишь чужие нужды выше своих?', points: 2 },
  { q: 'Боишься, что если будешь «плохим», тебя перестанут ценить?', points: 2 },
  { q: 'У тебя есть привычка извиняться даже когда не виноват?', points: 1 },
  { q: 'Ты редко просишь о помощи, чтобы не быть обузой?', points: 1 },
  { q: 'Чувствуешь раздражение, когда другие не ценят твои усилия?', points: 1 },
  { q: 'Тебе сложно сказать «нет» даже когда это вредит тебе?', points: 2 },
  { q: 'Ты стараешься всем нравиться, даже если это выматывает?', points: 2 },
  { q: 'Бывает, что ты злишься на себя за то, что опять всем уступил?', points: 1 },
];

// ─── 90 дней × 3 задания ──────────────────────────────────────────────────────
// Структура: { theme, tasks: [практика, наблюдение, рефлексия] }
const dailyPlan: { theme: string; lesson: string; tasks: [string, string, string] }[] = [
  { theme: 'Осознание паттерна', lesson: 'Угождение другим — это выученная стратегия выживания. В детстве она помогала получать любовь и безопасность. Но во взрослой жизни она превращается в ловушку: ты постоянно отдаёшь, не получая ничего взамен, и теряешь себя. Первый шаг к изменениям — просто заметить, как этот паттерн работает в твоей жизни.', tasks: ['Запиши 3 ситуации за последний месяц, когда ты сделал что-то против своей воли ради одобрения', 'В течение дня замечай каждый момент, когда хочешь сказать «да», но внутри чувствуешь «нет»', 'Вечером напиши: что ты теряешь, когда постоянно угождаешь другим?'] },
  { theme: 'Собственные потребности', lesson: 'Люди, привыкшие угождать, часто не знают чего хотят сами — они так долго фокусировались на чужих желаниях, что потеряли контакт со своими. Твои потребности реальны и важны. Умение их замечать и удовлетворять — не эгоизм, а основа психологического здоровья.', tasks: ['Составь список из 5 своих настоящих желаний — больших и маленьких', 'Выполни одно желание из списка только для себя, без оправданий', 'Запиши, что ты чувствовал, делая что-то исключительно для себя'] },
  { theme: 'Первое «нет»', lesson: '«Нет» — это полное предложение. Ты не обязан объяснять, оправдывать или смягчать отказ. Каждый раз когда ты говоришь «да» из страха, а не из желания — ты предаёшь себя. Первое «нет» всегда самое сложное. После него становится легче.', tasks: ['Скажи «нет» хотя бы одной просьбе сегодня — без объяснений', 'Заметь реакцию человека и свою реакцию на его реакцию', 'Напиши: что произошло? Что ты ожидал и что случилось на самом деле?'] },
  { theme: 'Честное мнение', lesson: 'Когда ты скрываешь своё настоящее мнение, ты лишаешь людей возможности по-настоящему тебя знать. Отношения, построенные на удобных ответах — это отношения с маской, а не с тобой. Честность — это уважение: к себе и к собеседнику.', tasks: ['Выскажи своё настоящее мнение в одном разговоре — даже если оно расходится с чужим', 'Наблюдай: как люди реагируют на твою честность?', 'Запиши: чего ты боялся до разговора и как всё прошло на самом деле'] },
  { theme: 'Извинения без вины', lesson: 'Автоматическое «извини» — это способ уменьшить себя, занять меньше места, избежать конфликта. Когда ты извиняешься за своё существование, ты посылаешь себе сигнал: «я недостаточно хорош». Извинение уместно только там, где ты действительно причинил вред.', tasks: ['Весь день не извиняйся, если ты реально ни в чём не виноват', 'Считай, сколько раз за день возникало желание сказать «извини» автоматически', 'Запиши: за что ты чаще всего извиняешься, хотя не должен?'] },
  { theme: 'Просьба о помощи', lesson: 'Просить о помощи — не слабость. Это доверие и честность. Люди, которые никогда не просят, часто несут непосильный груз в одиночку — и копят обиду на тех, кто «не помогает». Но как другие могут помочь, если ты не говоришь о своих нуждах?', tasks: ['Попроси кого-то о конкретной помощи — не намекни, а прямо попроси', 'Заметь своё внутреннее сопротивление перед просьбой', 'Напиши: что мешало тебе попросить раньше? Что случилось, когда попросил?'] },
  { theme: 'Тишина и себя', lesson: 'В постоянном шуме — соцсетях, новостях, разговорах — легко не слышать себя. Тишина пугает, потому что в ней всплывают настоящие мысли и чувства, которые мы привыкли заглушать. Но именно там — твой настоящий голос.', tasks: ['Проведи 30 минут в полной тишине без телефона — просто будь с собой', 'Заметь, какие мысли и чувства всплывают, когда нет внешних раздражителей', 'Запиши: о чём ты думал? Было ли некомфортно? Почему?'] },
  { theme: 'Реакция на неодобрение', lesson: 'Страх неодобрения — главный двигатель угождения. Мы готовы жертвовать своими интересами, лишь бы никто не был недоволен. Но неодобрение — это просто чужое мнение. Оно не определяет твою ценность.', tasks: ['Намеренно сделай что-то для себя на виду у других, не спрашивая разрешения', 'Наблюдай за своей реакцией, если кто-то выразит недовольство или удивление', 'Запиши: как ты себя чувствуешь, когда кто-то тебя не одобряет?'] },
  { theme: 'Маленький «эгоизм»', lesson: 'То, что ты называешь «эгоизмом» — часто просто нормальная забота о себе. Настоящий эгоизм — это причинять вред другим ради себя. Выбрать лучшее место, оставить последнее себе, сказать «я хочу» — это не эгоизм. Это здоровье.', tasks: ['Сделай что-то, что раньше считал эгоистичным — займи лучшее место, выбери первым, оставь последнее себе', 'Замечай осуждающий внутренний голос в момент действия', 'Напиши: почему ты считал это эгоизмом? Изменилось ли что-то после?'] },
  { theme: 'Благодарность себе', lesson: 'Мы легко замечаем свои ошибки и почти никогда не замечаем того, что делаем хорошо. Самокритика — привычный режим. Самопохвала — непривычный и дискомфортный. Но именно она строит здоровую самооценку.', tasks: ['Найди один поступок за последние дни, который ты сделал для себя, и похвали себя за него вслух', 'В течение дня замечай моменты, когда ты ставишь себя на первое место', 'Запиши: легко ли тебе хвалить себя? Почему?'] },
  { theme: 'Роль спасателя', lesson: 'Спасатель берётся решать проблемы других — даже когда его не просят. Это выглядит как доброта, но часто за этим стоит потребность в одобрении или контроле. Постоянное спасение лишает других людей их собственного опыта и роста.', tasks: ['Откажись от одной роли «спасателя» — не бросайся помогать там, где тебя не просили', 'Наблюдай: справился ли человек сам?', 'Напиши: почему ты обычно спасаешь? Что ты получаешь от этой роли?'] },
  { theme: 'Желания вслух', lesson: 'Говорить о своих желаниях вслух — это уязвимость. Ты рискуешь получить «нет». Но молчание о желаниях гарантирует, что ты их не получишь. Кроме того, озвученное желание становится реальным — для тебя самого.', tasks: ['Запиши свои настоящие желания на ближайшие 3 дня — конкретно и честно', 'Скажи одно из желаний вслух кому-то близкому', 'Напиши: легко ли тебе говорить о своих желаниях? Почему?'] },
  { theme: 'Удовольствие без оправданий', lesson: 'Люди с паттерном угождения часто чувствуют вину за удовольствие — особенно если оно «бесполезно». Но удовольствие не нужно заслуживать. Отдых, радость, развлечение — это не награда за продуктивность, это часть полноценной жизни.', tasks: ['Сделай что-то приятное для себя и не объясняй никому, зачем ты это делаешь', 'Замечай, возникает ли желание оправдаться или объяснить своё удовольствие', 'Запиши: от чего ты получил удовольствие? Было ли чувство вины?'] },
  { theme: 'Честное недовольство', lesson: 'Замалчивать недовольство — это не вежливость, это накопление напряжения. Рано или поздно оно выходит взрывом — или разрушает отношения изнутри. Спокойно сказанное недовольство освобождает и даёт другому человеку шанс измениться.', tasks: ['Выскажи своё недовольство одной ситуацией — спокойно, без агрессии', 'Наблюдай за реакцией другого человека и своей реакцией на его ответ', 'Напиши: что было сложнее всего — сказать или ждать реакции?'] },
  { theme: 'Угадывание желаний', lesson: 'Угадывать чужие желания заранее — это попытка контролировать ситуацию и избежать конфликта. Но это изматывает и лишает отношения естественности. Люди взрослые — они могут сказать, чего хотят, если их спросить или подождать.', tasks: ['Весь день не пытайся «читать мысли» и угадывать, что от тебя хотят — жди прямой просьбы', 'Считай, сколько раз за день хотелось угадать заранее', 'Запиши: зачем ты обычно угадываешь чужие желания?'] },
  { theme: 'Чужая ответственность', lesson: 'Брать на себя чужую ответственность — значит лишать человека его собственного опыта и роста. Это также истощает тебя. Ты отвечаешь за свои действия и чувства. Другие — за свои. Это не холодность, это уважение к автономии каждого.', tasks: ['Найди одну ситуацию, где ты взял на себя чужую ответственность — и отдай её обратно', 'Наблюдай за своим дискомфортом, когда перестаёшь решать за других', 'Напиши: за что ты несёшь ответственность, хотя не должен?'] },
  { theme: 'Пауза перед ответом', lesson: 'Автоматическое «да» — это рефлекс, а не осознанный выбор. Пауза — это пространство между стимулом и реакцией, в котором живёт твоя свобода. Три секунды молчания — и ты уже отвечаешь из себя, а не из страха.', tasks: ['На каждую просьбу сегодня делай паузу 3–5 секунд, прежде чем ответить', 'Замечай, что происходит внутри в эту паузу — страх, облегчение, ясность?', 'Напиши: что изменилось, когда ты не отвечал автоматически?'] },
  { theme: 'Цена угождения', lesson: 'Угождение не бесплатно. Ты платишь за него временем, энергией, здоровьем, самоуважением. Пока эта цена остаётся невидимой — паттерн продолжается. Когда ты начинаешь её замечать — появляется мотивация меняться.', tasks: ['Запиши конкретно: что ты теряешь — время, энергию, деньги, здоровье — когда всегда угождаешь', 'Найди одну ситуацию за день, где ты угождал в ущерб себе, и поступи иначе', 'Напиши итог дня: что ты почувствовал, поставив себя на первое место?'] },
  { theme: 'Свои потребности первыми', lesson: 'В самолёте говорят: сначала надень маску на себя, потом на ребёнка. Это не эгоизм — это здравый смысл. Ты не можешь давать из пустого сосуда. Забота о себе делает тебя способным по-настоящему заботиться о других.', tasks: ['Один раз сегодня поставь свою потребность выше чужой — осознанно', 'Наблюдай за своими ощущениями до, во время и после', 'Напиши: что ты чувствовал? Случилось ли что-то плохое?'] },
  { theme: 'Тишина внутри', lesson: 'Мы боимся тишины, потому что в ней слышен внутренний критик. Но там же — и внутренний мудрец. Регулярные моменты тишины учат слышать себя, различать свои желания и страхи, принимать более осознанные решения.', tasks: ['Проведи один час в тишине — без музыки, подкастов, соцсетей', 'Замечай, что ты делаешь с дискомфортом тишины', 'Запиши: какие мысли о себе приходят, когда не на что отвлекаться?'] },
  { theme: '«Я не хочу»', lesson: '«Не могу» — это ложь, которую мы говорим, чтобы не брать ответственность за свой выбор. «Не хочу» — честность. Разница огромна: первое делает тебя жертвой обстоятельств, второе — автором своей жизни. Это маленькое слово меняет всё.', tasks: ['Скажи «я не хочу» вслух хотя бы один раз — не «не могу», не «занят», а именно «не хочу»', 'Замечай реакцию другого человека и свой внутренний дискомфорт', 'Напиши: в чём разница между «не могу» и «не хочу»? Почему это важно?'] },
  { theme: 'Выбор без оправданий', lesson: 'Постоянные объяснения своих решений — это скрытая просьба об одобрении. Когда ты объясняешь каждый выбор, ты как будто говоришь: «Пожалуйста, скажи, что я поступил правильно». Зрелость — это доверять себе настолько, чтобы не нуждаться в этом.', tasks: ['Прими одно решение сегодня и не объясняй его никому', 'Замечай, сколько раз возникало желание объяснить или оправдаться', 'Напиши: почему ты обычно оправдываешь свои выборы?'] },
  { theme: 'Свои качества', lesson: 'Здоровая самооценка — это не высокомерие. Это реалистичный, честный взгляд на себя, включающий как слабости, так и сильные стороны. Люди с паттерном угождения часто хорошо видят свои недостатки и почти не замечают достоинств.', tasks: ['Запиши 5 качеств, которые ты в себе ценишь — без иронии и самокритики', 'Скажи одно из них вслух перед зеркалом', 'Напиши: сложно ли тебе говорить о своих достоинствах? Почему?'] },
  { theme: 'Страх осуждения', lesson: 'Страх осуждения заставляет нас жить чужой жизнью. Мы откладываем мечты, подавляем желания, меняем поведение — лишь бы никто не осудил. Но те, кто осуждает твои настоящие желания — не твои люди. Твои люди примут тебя настоящего.', tasks: ['Сделай одну вещь, которую ты откладывал из-за страха чужой оценки', 'Замечай свои ощущения до, во время и после действия', 'Напиши: что случилось? Оправдался ли страх?'] },
  { theme: 'Прямая просьба', lesson: 'Намёки — это попытка получить желаемое, не рискуя отказом. Но они редко работают и создают пассивную агрессию. Прямая просьба — это уважение к себе и к другому человеку. Да, можно получить «нет». Зато ты точно знаешь ответ.', tasks: ['Попроси о том, чего ты действительно хочешь — конкретно и прямо', 'Замечай свой дискомфорт и желание «намекнуть» вместо того чтобы попросить', 'Напиши: получил ли ты то, о чём просил? Как это повлияло на тебя?'] },
  { theme: 'Невмешательство', lesson: 'Доверять людям — значит верить, что они способны справляться со своей жизнью. Постоянное вмешательство, даже из лучших побуждений, говорит: «Я не верю, что ты справишься». Иногда лучший подарок — дать человеку его собственный опыт.', tasks: ['Найди ситуацию, где другой человек справляется сам — и не вмешивайся', 'Наблюдай за своим желанием вмешаться и «помочь»', 'Напиши: что значит доверять другим людям их собственный опыт?'] },
  { theme: 'Фокус на чувствах', lesson: 'Люди с паттерном угождения часто отрезаны от своих чувств — они так привыкли фокусироваться на чужих эмоциях, что перестали замечать свои. Чувства — это компас. Они сигнализируют о нарушенных границах, невыполненных потребностях, истинных желаниях.', tasks: ['Весь день замечай свои чувства — не мысли о чувствах, а сами чувства', 'Назови каждое чувство точным словом: не «плохо», а «тревожно», «обидно», «злюсь»', 'Напиши: какие чувства ты обычно игнорируешь или подавляешь?'] },
  { theme: '«Это важно для меня»', lesson: 'Заявлять о своей важности — не нарциссизм. Это базовое самоуважение. Когда ты говоришь «это важно для меня», ты даёшь другому человеку информацию о тебе и возможность учесть твои интересы. Без этого — он просто не знает.', tasks: ['Скажи фразу «это важно для меня» вслух в одном разговоре', 'Наблюдай за реакцией собеседника и своей реакцией на неё', 'Напиши: легко ли тебе заявлять о своей важности? Что мешает?'] },
  { theme: 'Чужие эмоции', lesson: 'Ты не можешь нести ответственность за то, как чувствуют себя другие. Это их эмоции, их работа. Сочувствовать — да. Поддерживать — да. Но брать на себя чужую боль или злость и пытаться их «починить» — это слияние, которое истощает и не помогает.', tasks: ['Найди ситуацию, где ты берёшь на себя чужие эмоции — и откажись это делать', 'Наблюдай за своим дискомфортом, когда перестаёшь нести ответственность за чужое настроение?', 'Напиши: почему ты берёшь на себя чужие эмоции? Что за этим стоит?'] },
  { theme: 'Итоги первого месяца', lesson: 'Тридцать дней — это достаточно, чтобы увидеть первые изменения. Не всегда очевидные снаружи, но ощутимые внутри. Рефлексия — это не самокопание. Это способ закрепить изменения, увидеть прогресс и понять, куда двигаться дальше.', tasks: ['Перечитай все свои записи за 30 дней — не редактируй, просто читай', 'Выпиши 3 самых важных открытия о себе за этот месяц', 'Напиши: кем ты был 30 дней назад и что изменилось прямо сейчас?'] },
  { theme: 'Утренний вопрос', lesson: 'Большинство людей начинают день с вопроса «что мне нужно сделать?». Попробуй начинать с «чего я хочу сегодня?». Это маленькое изменение постепенно перестраивает фокус с обязательств перед другими на контакт с собой.', tasks: ['Начни день с вопроса вслух: «Чего я хочу сегодня?» — и запиши ответ', 'В течение дня делай хотя бы одно действие в соответствии с этим желанием', 'Вечером напиши: удалось ли прожить день так, как ты хотел?'] },
  { theme: 'Конструктивная злость', lesson: 'Злость — не плохая эмоция. Это сигнал нарушенной границы или неудовлетворённой потребности. Подавленная злость накапливается и выходит либо взрывом, либо депрессией. Конструктивная злость — это информация, высказанная спокойно и по делу.', tasks: ['Найди ситуацию, где ты злишься или раздражён — и выскажи это спокойно', 'Замечай разницу между «взорваться» и «сказать о злости»', 'Напиши: что произошло, когда ты выразил злость без агрессии?'] },
  { theme: 'Ощущение достоинства', lesson: 'Достоинство — это не то, что нужно заслужить. Это врождённое право каждого человека. Когда ты отказываешься от лучшего, постоянно уступаешь и соглашаешься на меньшее — ты посылаешь себе сигнал о своей «меньшей ценности». Пора это менять.', tasks: ['Сделай что-то, что раньше казалось тебе «недостойным» или «слишком много» для тебя', 'Замечай внутренний голос, который говорит «ты не заслуживаешь»', 'Напиши: откуда взялся этот голос? Чей он на самом деле?'] },
  { theme: 'Несогласие', lesson: 'Несогласие — это не конец отношений. Здоровые отношения выдерживают разные мнения. Когда ты всегда соглашаешься — ты не надёжный человек, ты предсказуемый. Люди уважают тех, кто может сказать «я думаю иначе» — спокойно и уверенно.', tasks: ['Не соглашайся с чем-то, с чем ты внутренне несогласен — скажи об этом прямо', 'Наблюдай: пытаешься ли ты смягчить несогласие, чтобы не обидеть?', 'Напиши: что случилось? Разрушилось ли что-то?'] },
  { theme: 'Карта границ', lesson: 'Граница — это не стена и не агрессия. Это просто информация о том, что для тебя приемлемо, а что нет. Чёткие границы делают отношения более честными и предсказуемыми. Люди, которые тебя уважают, примут твои границы.', tasks: ['Запиши 5 границ, которые ты уже начал ставить за последний месяц', 'Найди одну границу, которую ты пока боишься поставить', 'Напиши: что мешает поставить эту границу? Что изменится, когда ты её поставишь?'] },
  { theme: 'День без оправданий', lesson: 'Оправдание — это разрешение, которое ты просишь у других на свои собственные действия. Но ты уже взрослый человек. Тебе не нужно разрешение жить своей жизнью. Попробуй прожить один день, доверяя своим решениям без объяснений.', tasks: ['Весь день не оправдывайся за свои решения и поступки', 'Считай, сколько раз хотелось оправдаться', 'Напиши: что чувствуешь, когда живёшь без постоянных объяснений?'] },
  { theme: 'Стыд и просьба', lesson: 'Стыд говорит: «ты плохой». Вина говорит: «ты сделал что-то плохое». Это разные вещи. Стыд заставляет скрывать потребности — ведь если ты попросишь, все увидят, что тебе чего-то не хватает. Но потребности есть у всех. Это не слабость.', tasks: ['Попроси о том, в чём раньше стыдился признаться, что тебе это нужно', 'Замечай физические ощущения стыда — где он в теле?', 'Напиши: что произошло? Оправдался ли стыд?'] },
  { theme: 'Чужое настроение', lesson: 'Если кто-то рядом в плохом настроении — это не обязательно твоя вина и не твоя работа это исправить. Попытки «починить» чужое настроение часто раздражают, а не помогают. Иногда лучшее, что ты можешь сделать — просто быть рядом, не пытаясь ничего менять.', tasks: ['Замечай каждый момент, когда ты пытаешься «починить» чужое настроение', 'Хотя бы раз откажись это делать — просто будь рядом, не спасай', 'Напиши: что происходит с тобой, когда другой человек в плохом настроении?'] },
  { theme: 'Пауза перед «да»', lesson: 'Осознанное «да» — это выбор. Автоматическое «да» — это страх. Разница между ними огромна: первое даёт энергию, второе — истощает. Когда каждое твоё «да» проходит проверку «я действительно этого хочу?» — жизнь становится твоей.', tasks: ['На каждое «да» сегодня делай паузу и спрашивай себя: «Я действительно этого хочу?»', 'Замечай, сколько «да» рождается из страха, а не из желания', 'Напиши: как изменилось качество твоих «да» за день, когда ты начал проверять их?'] },
  { theme: 'Самопохвала', lesson: 'Внутренний критик работает без выходных. Внутренний наставник — почти никогда. Но именно похвала закрепляет новое поведение эффективнее критики. Хвалить себя — это не самолюбование, это педагогика наоборот: ты учишь себя тому, что хочешь повторять.', tasks: ['Найди один поступок за день, который ты сделал для себя — и похвали себя конкретно, не общими словами', 'Скажи похвалу себе вслух — перед зеркалом или просто в комнате', 'Напиши: что мешает тебе хвалить себя? Что ты чувствуешь, когда это делаешь?'] },
  { theme: 'Открытое желание', lesson: 'Намёк — это замаскированная просьба с отказом от ответственности. «Что-то холодно стало» вместо «закрой окно, пожалуйста». Прямое желание — это уважение к себе и к собеседнику. Да, можно получить отказ. Но это честно.', tasks: ['Выскажи своё желание открыто — не намёком, не через «может быть», а прямо', 'Наблюдай за реакцией людей на твою прямоту', 'Напиши: что изменилось, когда ты перестал намекать и сказал прямо?'] },
  { theme: 'Помощь без запроса', lesson: 'Помогать, когда не просят — это не всегда доброта. Иногда это контроль, иногда — способ чувствовать себя нужным, иногда — скрытое ожидание благодарности. Помощь по запросу — честнее и уважительнее к автономии другого человека.', tasks: ['Весь день помогай только тогда, когда тебя об этом прямо попросят', 'Замечай порывы «броситься помочь» без запроса — и останавливай их', 'Напиши: как часто ты помогаешь, потому что действительно хочешь, а не потому что боишься не помочь?'] },
  { theme: 'Слушать только себя', lesson: 'Постоянный фокус на других истощает. Периодически нужно полностью переключаться на себя — свои мысли, желания, ощущения. Это не эгоизм, это восстановление. Как сон: без него невозможно функционировать.', tasks: ['Проведи полдня в режиме «только я» — делай только то, что хочешь ты', 'Замечай тревогу от того, что ты «недостаточно полезен»', 'Напиши: что ты чувствуешь, когда фокусируешься только на себе?'] },
  { theme: '«Это мои границы»', lesson: 'Называть что-то своей границей — это не объяснение и не оправдание. Это просто информация. «Это мои границы» — законченное высказывание, которое не требует продолжения. Ты не должен объяснять, почему у тебя есть границы. Они просто есть.', tasks: ['Скажи фразу «это мои границы» в одной реальной ситуации — спокойно и твёрдо', 'Наблюдай: пытается ли человек оспорить твою границу?', 'Напиши: как ты себя чувствовал, когда назвал это своей границей?'] },
  { theme: 'Итоги полутора месяцев', lesson: 'Полтора месяца — это уже не начало. Паттерны начинают меняться. Иногда это почти незаметно изнутри, но люди вокруг уже могут замечать. Важно останавливаться и замечать изменения самому — это питает мотивацию продолжать.', tasks: ['Выпиши 5 конкретных изменений в своём поведении за 45 дней', 'Найди одну сферу жизни, где изменений пока нет — и напиши почему', 'Напиши: что самое сложное в этом пути? Что тебя удивило?'] },
  { theme: 'Действие вопреки страху', lesson: 'Страх не исчезает до действия. Он исчезает во время или после. Ждать, пока страх пройдёт — значит не действовать никогда. Мужество — это не отсутствие страха. Это действие несмотря на него.', tasks: ['Сделай одно действие, которого боялся из-за возможного осуждения', 'Замечай страх до действия и ощущения после', 'Напиши: изменилось ли что-то в реальности? Чему ты научился?'] },
  { theme: 'Эмоции без извинений', lesson: 'Извиняться за свои эмоции — это говорить: «Мне жаль, что я чувствую». Но чувства — это не ошибка. Они информация о твоём внутреннем состоянии. Ты имеешь право злиться, грустить, радоваться — без объяснений и извинений.', tasks: ['Вырази любую эмоцию — радость, злость, грусть — и не извиняйся за неё', 'Замечай автоматическое «прости» после проявления чувств', 'Напиши: почему ты обычно извиняешься за свои эмоции?'] },
  { theme: 'Первое место', lesson: 'Ставить себя на первое место хотя бы иногда — это не значит не думать о других. Это значит признавать, что твои потребности существуют и важны. Человек, который никогда не ставит себя на первое место, рано или поздно сломается или взорвётся.', tasks: ['Поставь свои потребности на первое место в конкретной ситуации — осознанно', 'Наблюдай: испытываешь ли ты вину? Откуда она?', 'Напиши: что произошло, когда ты поставил себя первым?'] },
  { theme: 'Жизнь без маски', lesson: 'Маска удобного человека защищает от отвержения — но она же и мешает настоящей близости. Люди любят маску, а не тебя. Снять маску — страшно. Но только так можно узнать, кто тебя любит по-настоящему.', tasks: ['Проведи один день максимально честно — не притворяйся, что всё окей, если это не так', 'Замечай моменты, когда надеваешь «маску» удобного человека', 'Напиши: кем ты являешься без маски?'] },
  { theme: '«Нет» большой просьбе', lesson: 'Маленькие «нет» — это тренировка. Большое «нет» — это экзамен. Отказать в чём-то важном, что идёт вразрез с твоими интересами — это не предательство. Это честность. И это проверяет, насколько отношения строятся на уважении, а не на удобстве.', tasks: ['Откажи в большой или важной просьбе, которая идёт вразрез с твоими интересами', 'Наблюдай за своей реакцией и реакцией другого человека', 'Напиши: что произошло после «нет»? Разрушилось ли что-то важное?'] },
  { theme: 'Открытая поддержка', lesson: 'Принимать поддержку — такой же навык, как давать её. Многие умеют заботиться о других, но не умеют принимать заботу сами — это кажется слабостью или обузой. Но позволить себе быть поддержанным — это доверие, которое укрепляет отношения.', tasks: ['Попроси о поддержке открыто — не через жалобы и намёки, а прямым запросом', 'Замечай дискомфорт от уязвимости, когда просишь напрямую', 'Напиши: что ты получил? Как это было — попросить и получить поддержку?'] },
  { theme: 'Чужие проблемы', lesson: 'Нести чужие проблемы — это иллюзия контроля и способ не встречаться со своими. Пока ты решаешь чужие трудности, твои остаются нетронутыми. Отпустить чужую проблему — не равно бросить человека. Это вернуть ему его жизнь.', tasks: ['Найди одну чужую проблему, которую ты несёшь на себе — и верни её владельцу', 'Наблюдай за тревогой: «а вдруг они не справятся?»', 'Напиши: чья это на самом деле проблема? Что происходит, когда ты её отпускаешь?'] },
  { theme: 'Чистое удовольствие', lesson: 'Удовольствие ради удовольствия — без пользы, без цели, без оправданий — это одна из самых трудных вещей для людей с паттерном угождения. Но именно оно восстанавливает. Ты заслуживаешь радости просто потому, что живёшь.', tasks: ['Сделай что-то только ради своего удовольствия — без пользы, без цели, просто потому что нравится', 'Замечай, комфортно ли тебе делать что-то «просто так»', 'Напиши: что приносит тебе настоящее удовольствие?'] },
  { theme: 'Благодарность себе', lesson: 'Написать письмо себе с благодарностью — это не нарциссизм. Это способ увидеть себя с той теплотой, с которой ты видишь близких людей. Ты прошёл уже больше половины пути. Это заслуживает признания.', tasks: ['Напиши письмо себе — поблагодари за всё, что ты уже прошёл и сделал', 'Прочитай это письмо вслух', 'Напиши: что ты чувствовал, читая письмо? Что важного ты себе сказал?'] },
  { theme: 'Итоги двух месяцев', lesson: 'Два месяца — это серьёзно. Новые паттерны уже начали укореняться. Мозг буквально перестраивается — новые нейронные связи формируются, старые ослабевают. Остановись и отметь это. Не беги вперёд не замечая пройденного.', tasks: ['Перечитай все свои записи за 60 дней — найди главную нить изменений', 'Выпиши 3 самых важных урока второго месяца', 'Напиши: кем ты стал за 60 дней? Что тебя больше всего изменило?'] },
  { theme: 'Жизнь без угождения', lesson: 'День без угождения — это не день эгоизма. Это день, когда ты действуешь из своих настоящих желаний и ценностей, а не из страха чужой реакции. Попробуй прожить такой день — и почувствуй разницу в уровне энергии.', tasks: ['Весь день делай только то, что хочешь делать, а не то, чего, как ты думаешь, ждут другие', 'Замечай разницу в уровне энергии', 'Напиши: как ощущается день, прожитый для себя?'] },
  { theme: 'Неудобная правда', lesson: 'Правда, которую ты замалчиваешь, не исчезает. Она живёт внутри и отравляет отношения медленно. Сказать правду — всегда страшно. Но почти всегда после неё становится легче — независимо от реакции другого человека.', tasks: ['Скажи кому-то правду, которую ты обычно замалчиваешь из страха реакции', 'Наблюдай за реакцией и своим ощущением после честности', 'Напиши: что освободилось в тебе, когда ты сказал правду?'] },
  { theme: 'Отдых без вины', lesson: 'Продуктивность — не мера человеческой ценности. Ты ценен не потому что работаешь и делаешь — а потому что существуешь. Отдых — это не лень. Это физиологическая необходимость и право каждого живого существа.', tasks: ['Отдохни сегодня — полностью, не делая ничего «полезного» — без чувства вины', 'Замечай голос, который говорит «ты должен что-то делать»', 'Напиши: почему отдых вызывает вину? Что стоит за этим?'] },
  { theme: 'Признание прогресса', lesson: 'Люди с высокой самокритикой замечают прогресс последними. Они привыкли видеть то, чего ещё нет, а не то, что уже изменилось. Намеренное признание прогресса — это не самодовольство, это топливо для продолжения пути.', tasks: ['Выпиши 10 конкретных изменений в себе за последние 60 дней', 'Расскажи об одном из них кому-то, кому доверяешь', 'Напиши: как ты относишься к тому, кем становишься?'] },
  { theme: 'Смелое действие', lesson: 'Смелость — это мышца. Она тренируется маленькими действиями вопреки страху. Каждый раз, когда ты делаешь что-то страшное — ты немного расширяешь свою зону комфорта. Со временем то, что было страшным, становится обычным.', tasks: ['Сделай одну смелую вещь, которую ты откладывал из-за страха', 'Замечай, что происходит внутри в момент действия', 'Напиши: что изменилось после этого действия?'] },
  { theme: 'Чужое счастье', lesson: 'Ты не можешь сделать другого человека счастливым. Это его работа. Ты можешь создавать условия, поддерживать, любить — но не нести ответственность за его внутреннее состояние. Эта иллюзия контроля истощает и не работает.', tasks: ['Найди ситуацию, где ты берёшь ответственность за чужое счастье — и осознанно откажись', 'Наблюдай за тревогой: «я должен сделать их счастливыми»', 'Напиши: почему ты чувствуешь ответственность за счастье других?'] },
  { theme: 'Свои правила', lesson: 'Жить по чужим правилам — это жить чужой жизнью. У тебя есть право устанавливать правила для своих отношений и своей жизни. Это не ультиматум, это ясность. Люди, которые тебя уважают, примут твои правила или договорятся.', tasks: ['Определи одно своё правило для отношений с людьми и живи по нему весь день', 'Замечай, когда другие (или ты сам) пытаются нарушить это правило', 'Напиши: какие правила ты хочешь установить для своей жизни?'] },
  { theme: 'Спокойная граница', lesson: 'Граница, поставленная со злостью, выглядит как агрессия. Граница, поставленная спокойно — как уверенность. Спокойный тон говорит: «Я уверен в себе настолько, что мне не нужно кричать». Это гораздо эффективнее.', tasks: ['Поставь одну границу абсолютно спокойным тоном — без агрессии, без оправданий', 'Наблюдай: как реагируют люди на спокойное «нет»?', 'Напиши: в чём сила спокойной границы?'] },
  { theme: 'Кем я становлюсь', lesson: 'Изменения происходят медленно, изнутри наружу. Сложно заметить, как меняешься ты сам. Но если остановиться и честно сравнить — кем ты был два месяца назад и кем ты являешься сейчас — разница будет видна.', tasks: ['Запиши подробный портрет себя — кем ты становишься в процессе этого пути', 'Сравни его с тем, кем ты был 63 дня назад', 'Напиши: что тебя больше всего удивляет в своих изменениях?'] },
  { theme: 'Осознанное согласие', lesson: '«Да» из страха — это не согласие, это капитуляция. Настоящее «да» рождается из желания или осознанного выбора. Когда ты начинаешь проверять каждое своё «да» — ты возвращаешь себе авторство своей жизни.', tasks: ['На каждое соглашение сегодня спрашивай себя: «Я хочу это или боюсь отказать?»', 'Откажись от одного автоматического «да»', 'Напиши: как изменилось качество твоих «да», когда они стали осознанными?'] },
  { theme: 'Говорить о желаниях', lesson: 'Каждый раз, когда ты говоришь о своих желаниях прямо — ты тренируешь уязвимость. Сначала страшно. Потом — освобождает. Люди, которые тебя ценят, рады знать твои желания. Это сближает, а не отталкивает.', tasks: ['Три раза за день скажи вслух о своём желании — разным людям', 'Замечай, как реагируют люди на твою прямоту', 'Напиши: что происходит в отношениях, когда ты говоришь о желаниях прямо?'] },
  { theme: 'Не спасать', lesson: 'За желанием спасти часто стоит не только доброта, но и страх — что человек не справится, что ты потеряешь над ним влияние, что тебя перестанут считать нужным. Настоящая поддержка — быть рядом, когда просят, и доверять человеку, когда не просят.', tasks: ['Весь день не инициируй спасение тех, кто не просил о помощи', 'Замечай тревогу «а вдруг им плохо, я должен помочь»', 'Напиши: что стоит за желанием спасать?'] },
  { theme: 'Честность с собой', lesson: 'Самообман — самый тихий враг изменений. Мы часто говорим себе удобную версию реальности, чтобы не встречаться с болью или необходимостью меняться. Честность с собой — это не самобичевание, это ясность, которая освобождает.', tasks: ['Запиши одну вещь, которую ты до сих пор скрываешь от себя', 'Прочитай это вслух', 'Напиши: что меняется, когда ты позволяешь себе знать правду о себе?'] },
  { theme: 'Итоги 70 дней', lesson: 'Семьдесят дней — это уже не эксперимент. Это новый способ жить. Посмотри назад: что ты больше не делаешь? От чего отказался? Что появилось нового? Эти изменения — результат твоей работы, не случайность.', tasks: ['Составь список: что ты больше не делаешь из того, что делал 70 дней назад', 'Найди одну область, где паттерн угождения ещё сильный', 'Напиши: что нужно, чтобы изменить эту последнюю область?'] },
  { theme: 'Подлинность', lesson: 'Подлинность — это не «говори всё что думаешь». Это соответствие между тем, что ты чувствуешь внутри, и тем, как ты действуешь снаружи. Когда эти два уровня совпадают — исчезает тревога, приходит покой и появляется настоящий контакт с людьми.', tasks: ['Весь день будь максимально собой — говори то, что думаешь, делай то, что хочешь', 'Замечай моменты, когда надеваешь маску', 'Напиши: что ты чувствуешь, когда ты по-настоящему собой?'] },
  { theme: 'Твои границы — твой выбор', lesson: 'Граница — это не правило, которое ты устанавливаешь для других. Это описание того, как ты будешь поступать в той или иной ситуации. «Если ты повысишь на меня голос, я уйду» — это граница. Ты не контролируешь другого, ты контролируешь себя.', tasks: ['Объясни одному человеку одну свою границу — не оправдываясь, а просто информируя', 'Наблюдай за его реакцией без желания её «исправить»', 'Напиши: как ощущается, когда ты просто информируешь, а не оправдываешься?'] },
  { theme: 'Прощание с «удобностью»', lesson: 'Быть удобным — значит отдавать приоритет чужому комфорту над своим. Это изматывает и разрушает самоуважение. Позволить себе быть иногда неудобным — это не стать плохим человеком. Это стать честным человеком.', tasks: ['Найди одну ситуацию, где ты ещё остаёшься «удобным» — и поступи иначе', 'Замечай страх потерять отношения из-за своей «неудобности»', 'Напиши: что ты выбираешь — быть удобным или быть собой?'] },
  { theme: 'Благодарность изменениям', lesson: 'Изменения даются тяжело — они требуют усилий, смелости, готовности к дискомфорту. Человек, который прошёл 75 дней этого пути, заслуживает признания. Не от других — от себя самого.', tasks: ['Поблагодари себя за каждое изменение последних 75 дней — конкретно и вслух', 'Найди одного человека, кто заметил твои изменения, и поговори с ним об этом', 'Напиши: как ты относишься к себе новому?'] },
  { theme: 'Свобода от чужих эмоций', lesson: 'Эмоциональная заразность — реальное явление. Мы перенимаем состояния тех, кто рядом. Но есть разница между сочувствием и слиянием. Сочувствие говорит: «Я вижу твою боль». Слияние говорит: «Твоя боль — это моя боль». Первое помогает, второе истощает.', tasks: ['Весь день напоминай себе: «Чужие эмоции — не мои»', 'Замечай каждый раз, когда чужое настроение влияет на твоё состояние', 'Напиши: что изменилось бы в твоей жизни, если бы ты полностью освободился от этой ответственности?'] },
  { theme: 'Прямое желание', lesson: 'С каждым разом просить становится легче. Это навык, который тренируется. На первой просьбе страшно. На десятой — привычно. На сотой — естественно. Ты уже далеко продвинулся по этому пути.', tasks: ['Попроси о том, чего хочешь, у трёх разных людей в течение дня', 'Замечай свой дискомфорт с каждой просьбой — уменьшается ли он?', 'Напиши: что ты заметил о своих отношениях, когда начал просить напрямую?'] },
  { theme: 'Доверие людям', lesson: 'Гиперопека — обратная сторона недоверия. Когда ты постоянно вмешиваешься, ты говоришь: «Я не верю, что ты справишься». Доверие — это риск. Но без него нет настоящих отношений, только контроль.', tasks: ['Позволь кому-то справиться с задачей самостоятельно — без твоей помощи и контроля', 'Наблюдай за желанием вмешаться и «сделать лучше»', 'Напиши: что происходит, когда ты доверяешь людям их собственный путь?'] },
  { theme: 'Жить без объяснений', lesson: 'Зрелость — это доверие себе настолько, чтобы не нуждаться в постоянном объяснении своих решений. Ты живёшь свою жизнь. Объяснения нужны только там, где это уместно и ты сам этого хочешь — не потому что боишься осуждения.', tasks: ['Весь день не объясняй свои решения, если тебя об этом не просят', 'Замечай импульс объяснить себя — и останавливай его', 'Напиши: что значит доверять своим решениям настолько, чтобы не объяснять их?'] },
  { theme: 'Итоги 80 дней', lesson: 'Восемьдесят дней. Ты уже не тот человек, что начинал. Паттерны, которые формировались годами, начали меняться. Это огромная работа. Последние 10 дней — не финиш, а закрепление. Посмотри на путь пройденный — и на путь впереди.', tasks: ['Перечитай все записи и выпиши главное открытие каждой из 10 прошедших недель', 'Определи, что изменилось в твоих отношениях с другими людьми', 'Напиши: каким человеком ты хочешь быть в следующие 10 дней?'] },
  { theme: 'Жизнь по своим правилам', lesson: 'Жить по своим правилам — не значит игнорировать других. Это значит иметь внутренний компас, который не зависит от чужого одобрения. Люди, которые живут по своим правилам, притягивают тех, кто их уважает, и отталкивают тех, кто хочет ими управлять.', tasks: ['Проживи день полностью по своим правилам — не подстраиваясь ни под кого', 'Замечай, кто и как реагирует на «нового» тебя', 'Напиши: как чувствуется жизнь, когда ты живёшь по своим правилам?'] },
  { theme: 'Чувства без оправданий', lesson: 'Ты не должен объяснять, почему ты чувствуешь то, что чувствуешь. Чувства — не аргумент в споре, не слабость, не ошибка. Они часть тебя. Когда ты перестаёшь извиняться за них — ты начинаешь жить полнее.', tasks: ['Три раза за день выражай свои чувства без извинений и оправданий', 'Замечай, как люди реагируют на твою эмоциональную честность', 'Напиши: что происходит в отношениях, когда ты перестаёшь извиняться за свои чувства?'] },
  { theme: 'Источник радости', lesson: 'Знать, что приносит тебе радость — и позволять себе это — один из главных навыков самопознания. Радость — не каприз. Это сигнал: «вот что делает тебя живым». Следуй за ней.', tasks: ['Сделай что-то, что приносит тебе настоящую радость — без связи с пользой для других', 'Замечай качество этой радости — чем она отличается от «заслуженной» радости?', 'Напиши: что ты понял о себе через свои источники радости?'] },
  { theme: 'Поддержка и уязвимость', lesson: 'Уязвимость — это не слабость. Это смелость быть увиденным настоящим. Когда ты позволяешь себе быть поддержанным — ты даёшь другому человеку возможность быть для тебя настоящим другом. Это углубляет близость.', tasks: ['Попроси о поддержке в чём-то важном для тебя', 'Позволь себе быть уязвимым в этот момент — не объясняй и не преуменьшай', 'Напиши: что ты получил, открывшись? Что значит для тебя принимать поддержку?'] },
  { theme: 'Освобождение от ответственности', lesson: 'Гиперответственность — это попытка контролировать мир через заботу обо всех. Но ты не можешь и не должен нести ответственность за всё и всех. Отпустить лишнюю ответственность — это не безразличие. Это трезвость.', tasks: ['Найди одну вещь, за которую ты несёшь ответственность, хотя не должен — и отпусти её сегодня', 'Наблюдай за чувством облегчения или тревоги', 'Напиши: что стоит за твоей потребностью контролировать и нести ответственность?'] },
  { theme: 'Твёрдые границы', lesson: 'Есть границы, которые не обсуждаются. Не потому что ты жёсткий, а потому что они защищают что-то важное для тебя. Знать свои твёрдые границы — и придерживаться их несмотря на давление — это зрелость.', tasks: ['Поставь одну границу, которую не нарушишь ни при каких обстоятельствах', 'Наблюдай: пытается ли кто-то её проверить?', 'Напиши: что значит иметь границу, которую ты не обсуждаешь?'] },
  { theme: 'Путь позади', lesson: 'Ты начинал этот путь как один человек — и заканчиваешь как другой. Это не преувеличение. 90 дней работы над собой меняют нейронные связи, паттерны поведения, отношение к себе. Посмотри назад с уважением к тому, кем ты был, и с гордостью за то, кем стал.', tasks: ['Напиши подробно: кем ты был 90 дней назад — что думал, как себя вёл, что чувствовал', 'Выпиши 5 самых важных изменений за весь путь', 'Напиши: за что ты больше всего благодарен себе за эти 90 дней?'] },
  { theme: 'Три главных изменения', lesson: 'Три изменения, которые повлияли на твою жизнь больше всего — это не случайность. Это результат твоего выбора возвращаться каждый день и делать работу. Назови их вслух — для себя и для тех, кому доверяешь.', tasks: ['Выбери 3 главных изменения, которые повлияли на твою жизнь больше всего', 'Расскажи о них кому-то близкому или запиши как будто рассказываешь', 'Напиши: как эти изменения повлияли на твои отношения с собой и другими?'] },
  { theme: 'Новая точка отсчёта', lesson: 'Этот путь не заканчивается на 90-м дне. Он становится новой точкой отсчёта — новым «нормально». То, что раньше требовало усилий, теперь становится привычным. То, что казалось невозможным — стало реальностью.', tasks: ['Запиши одно конкретное действие, которое ты теперь делаешь иначе, чем 90 дней назад', 'Найди ситуацию сегодня, где ты поступил так, как новый ты — и опиши её', 'Напиши: что для тебя теперь означает слово «граница»?'] },
  { theme: 'Письмо себе будущему', lesson: 'Письмо себе через год — это разговор с человеком, которым ты станешь. Ты уже знаешь, куда хочешь прийти. Напиши об этом. Запечатай намерение. Это мощнее любого плана.', tasks: ['Напиши письмо себе через год — что ты хочешь для него?', 'Запиши три обещания, которые ты даёшь себе после этих 90 дней', 'Напиши: что ты никогда больше не позволишь себе делать с собой?'] },
  { theme: 'Кем ты стал', lesson: 'Девяносто дней назад ты сделал первый шаг. Сегодня ты стоишь в конце этого пути — и в начале следующего. Ты стал другим человеком. Не идеальным. Но более честным, более свободным, более собой. Это и есть цель.', tasks: ['Напиши развёрнутый портрет себя нового — ценности, границы, желания, отношения', 'Прочитай его вслух — это ты сейчас', 'Напиши: что ты хочешь сказать себе, завершая эти 90 дней?'] },
];
// ─── Мотивационные сообщения ──────────────────────────────────────────────────
const motivationMessages = [
  { emoji: '🔥', title: 'День закрыт!', text: 'Три задания, три записи — ты действительно работал. Это не просто галочка.' },
  { emoji: '💪', title: 'Отличная работа!', text: 'Большинство людей никогда не делают то, что сделал ты сегодня. Ты уже другой.' },
  { emoji: '⭐', title: 'Так держать!', text: 'Границы — это не стены. Это уважение к себе. Ты учишься этому.' },
  { emoji: '🌱', title: 'Ты растёшь!', text: 'Изменения незаметны изнутри, но они происходят. Доверяй процессу.' },
  { emoji: '🦁', title: 'Смело!', text: 'Сказать «нет» или поставить себя на первое место — это сила, а не эгоизм.' },
  { emoji: '✨', title: 'Ещё один день!', text: 'Ты не угождаешь — ты живёшь. Это твоя жизнь, и ты её выбираешь.' },
  { emoji: '🏆', title: 'Победа!', text: '«Нет» — это полное предложение. Сегодня ты это доказал делом.' },
  { emoji: '🎯', title: 'В точку!', text: 'Твоя ценность не зависит от того, насколько ты удобен другим. Помни это.' },
  { emoji: '💎', title: 'Ты ценен!', text: 'Человек, который знает себе цену, не нуждается в постоянном одобрении.' },
  { emoji: '🚀', title: 'Вперёд!', text: 'Каждый выполненный день — кирпичик твоего нового «я». Строй смело.' },
];

// ─── Цитаты (90 штук) ─────────────────────────────────────────────────────────
const gloverQuotes = [
  { text: '«Нет» — это полное предложение.', context: 'О границах' },
  { text: 'Твои потребности так же важны, как и потребности других.', context: 'О самоценности' },
  { text: 'Угождать всем — значит предавать себя каждый день.', context: 'О верности себе' },
  { text: 'Ты не несёшь ответственности за чувства других людей.', context: 'О границах' },
  { text: 'Люди уважают тех, кто уважает себя.', context: 'О самоуважении' },
  { text: 'Страх конфликта создаёт именно тот конфликт, которого ты боишься.', context: 'О страхе' },
  { text: 'Одобрение других людей — это яд замедленного действия.', context: 'О зависимости' },
  { text: 'Граница — это не агрессия. Это уважение к себе.', context: 'О границах' },
  { text: 'Скрывать свои недостатки — значит лишать себя настоящей близости.', context: 'О уязвимости' },
  { text: 'Забота о себе — это не эгоизм. Это фундамент, на котором строится всё остальное.', context: 'О заботе' },
  { text: 'Когда скрываешь, кто ты есть — лишаешь людей возможности по-настоящему тебя любить.', context: 'О честности' },
  { text: 'Ты не можешь изменить других. Ты можешь изменить только себя.', context: 'О контроле' },
  { text: 'Принятие себя — это не финиш. Это начало.', context: 'О принятии' },
  { text: 'Чем больше пытаешься всем угодить, тем меньше тебя уважают.', context: 'О уважении' },
  { text: 'Попроси о том, чего хочешь. Худшее, что услышишь — «нет».', context: 'О просьбах' },
  { text: 'Когда даёшь, не ожидая ничего взамен — это щедрость. Иначе — манипуляция.', context: 'О мотивах' },
  { text: 'Стыд — главный инструмент, которым нас контролируют.', context: 'О стыде' },
  { text: 'Твоя ценность не определяется тем, насколько ты полезен другим.', context: 'О самоценности' },
  { text: 'Тот, кто всегда соглашается — не надёжный человек. Он просто боится конфликта.', context: 'О честности' },
  { text: 'Быть собой — единственный способ найти людей, которые полюбят тебя настоящего.', context: 'О подлинности' },
  { text: 'Когда перестаёшь бояться быть отвергнутым — становишься свободным.', context: 'О свободе' },
  { text: 'Люди, которые тебя ценят, примут твоё «нет». Остальные ценят не тебя, а твою уступчивость.', context: 'О ценности' },
  { text: 'Злость на себя за очередную уступку — сигнал: пора менять паттерн.', context: 'О осознанности' },
  { text: 'Извинение без вины — это не вежливость. Это привычка уменьшать себя.', context: 'О границах' },
  { text: 'Настоящая близость начинается там, где заканчивается маска.', context: 'О близости' },
  { text: 'Помогать из страха и помогать из любви — совершенно разные вещи.', context: 'О мотивах' },
  { text: 'Ты имеешь право хотеть. Просто хотеть — без оправданий.', context: 'О желаниях' },
  { text: 'Молчать, когда больно — не смелость. Это медленное разрушение.', context: 'О честности' },
  { text: 'Спасать тех, кто не просил о помощи — способ избежать собственной жизни.', context: 'О контроле' },
  { text: 'Первый месяц — самый важный. Ты уже начал.', context: 'О начале' },
  { text: 'Каждое утро — шанс спросить себя: чего я хочу сегодня?', context: 'О намерении' },
  { text: 'Злость — это не плохая эмоция. Это сигнал нарушенной границы.', context: 'О эмоциях' },
  { text: 'Ты заслуживаешь того, чего хочешь — не потому что заработал, а потому что существуешь.', context: 'О самоценности' },
  { text: 'Несогласие — это не предательство. Это честность.', context: 'О честности' },
  { text: 'Границы — это не способ оттолкнуть людей. Это способ подпустить правильных.', context: 'О границах' },
  { text: 'Жить без оправданий — значит доверять своим решениям.', context: 'О доверии себе' },
  { text: 'Стеснение просить — это страх оказаться обузой. Но ты ею не являешься.', context: 'О просьбах' },
  { text: 'Чужое настроение — не твоя ответственность и не твоя вина.', context: 'О границах' },
  { text: 'Пауза перед «да» — это не грубость. Это уважение к себе.', context: 'О границах' },
  { text: 'Хвалить себя — не самонадеянность. Это честное признание своих усилий.', context: 'О самоценности' },
  { text: 'Желание, высказанное вслух — уже наполовину исполненное.', context: 'О желаниях' },
  { text: 'Не каждый нуждается в спасении. Иногда люди справляются сами.', context: 'О контроле' },
  { text: 'Слушать себя — навык, который придётся тренировать.', context: 'О осознанности' },
  { text: 'Граница без объяснений — это не грубость. Просто граница.', context: 'О границах' },
  { text: 'Прожить полтора месяца честно с собой — это уже много.', context: 'О прогрессе' },
  { text: 'Страх — плохой советчик. Но отличный индикатор того, что важно.', context: 'О страхе' },
  { text: 'Эмоции не нужно заслуживать. Они просто есть — и это нормально.', context: 'О эмоциях' },
  { text: 'Ставить себя на первое место — не значит игнорировать других.', context: 'О заботе' },
  { text: 'Изменения заметны не изнутри, а в зеркале чужих реакций.', context: 'О росте' },
  { text: 'Жить без маски — страшно поначалу. Потом — единственный способ дышать.', context: 'О подлинности' },
  { text: 'Большое «нет» — это маленькое «да» себе.', context: 'О границах' },
  { text: 'Просить о поддержке — это не слабость. Это доверие.', context: 'О близости' },
  { text: 'Чужие проблемы не станут меньше от того, что ты возьмёшь их на себя.', context: 'О контроле' },
  { text: 'Удовольствие не нужно оправдывать. Оно самоценно.', context: 'О желаниях' },
  { text: 'Благодарность себе — редкий, но мощный инструмент роста.', context: 'О самоценности' },
  { text: 'Два месяца — это не просто цифра. Это новый способ жить.', context: 'О прогрессе' },
  { text: 'Угождение из привычки — это автопилот. Осознанность — это штурвал.', context: 'О осознанности' },
  { text: 'Правда, сказанная мягко — всё равно правда. И она освобождает.', context: 'О честности' },
  { text: 'Отдых — это не награда. Это необходимость.', context: 'О заботе' },
  { text: 'Прогресс — не прямая линия. Но ты движешься.', context: 'О прогрессе' },
  { text: 'Сделать страшное — лучший способ перестать его бояться.', context: 'О страхе' },
  { text: 'Чужое счастье — не твоя работа. Твоё — твоя.', context: 'О границах' },
  { text: 'Жить по своим правилам — не эгоизм. Это зрелость.', context: 'О зрелости' },
  { text: 'Спокойно сказанное «это мои границы» — мощнее любого крика.', context: 'О границах' },
  { text: 'Ты становишься кем-то новым. Это требует времени — и смелости.', context: 'О росте' },
  { text: 'Автоматическое согласие — это страх, одетый в вежливость.', context: 'О осознанности' },
  { text: 'Хотеть — и говорить об этом вслух — это одно действие.', context: 'О желаниях' },
  { text: 'Не спасай тех, кто может справиться сам. Дай им этот шанс.', context: 'О контроле' },
  { text: 'Жить без оправданий — значит уважать свои решения.', context: 'О доверии себе' },
  { text: 'Семьдесят дней — это не случайность. Это выбор.', context: 'О прогрессе' },
  { text: 'Маска удобного человека защищает от отвержения — и от настоящей близости.', context: 'О подлинности' },
  { text: 'Граница — это место, где заканчивается страх и начинается уважение.', context: 'О границах' },
  { text: 'То, что раньше казалось эгоизмом — часто просто здравый смысл.', context: 'О самоценности' },
  { text: 'Изменения в тебе — лучшая благодарность себе за пройденный путь.', context: 'О росте' },
  { text: 'Чужие эмоции — не твои. Сочувствовать можно, брать на себя — нет.', context: 'О границах' },
  { text: 'Говорить о своих желаниях открыто — это близость, а не уязвимость.', context: 'О близости' },
  { text: 'Фокус на себе — не нарциссизм. Это основа здоровых отношений.', context: 'О заботе' },
  { text: '«Нет» без вины — признак того, что ты вырос.', context: 'О росте' },
  { text: 'Отношение к себе — самый точный индикатор твоего прогресса.', context: 'О осознанности' },
  { text: 'Восемьдесят дней — ты уже не тот человек, что начинал.', context: 'О прогрессе' },
  { text: 'Свои правила — не тюрьма. Это свобода, которую ты сам построил.', context: 'О свободе' },
  { text: 'Чувства не нужно объяснять. Они имеют право быть.', context: 'О эмоциях' },
  { text: 'Радость — не роскошь. Это твоё право.', context: 'О желаниях' },
  { text: 'Просить поддержки — значит доверять. Это сила.', context: 'О близости' },
  { text: 'Настроение другого человека — его работа, не твоя.', context: 'О границах' },
  { text: 'Граница, сказанная спокойно, работает лучше, чем сказанная со злостью.', context: 'О границах' },
  { text: 'Ты прошёл долгий путь. Это достойно уважения — в первую очередь твоего собственного.', context: 'О прогрессе' },
  { text: 'Три главных изменения — это только начало новой версии тебя.', context: 'О росте' },
  { text: 'Девяносто дней назад ты сделал первый шаг. Посмотри, кем ты стал.', context: 'О финале' },
];

function getDailyQuote(currentDay: number) {
  const idx = Math.max(0, Math.min(currentDay - 1, gloverQuotes.length - 1));
  return gloverQuotes[idx];
}

// ─── Apple Theme ──────────────────────────────────────────────────────────────
const getColors = (isDark: boolean) => ({
  // Backgrounds
  bg: isDark ? '#000' : '#f5f5f7',
  card: isDark ? '#1c1c1e' : '#fff',
  cardSecondary: isDark ? '#2c2c2e' : '#f9f9f9',
  
  // Text
  text: isDark ? '#f5f5f7' : '#1d1d1f',
  textSec: isDark ? '#98989d' : '#86868b',
  
  // UI Elements
  border: isDark ? '#38383a' : '#d2d2d7',
  separator: isDark ? '#38383a' : '#c6c6c8',
  
  // System Colors
  accent: isDark ? '#0a84ff' : '#007aff',
  success: isDark ? '#30d158' : '#34c759',
  warning: isDark ? '#ff9f0a' : '#ff9500',
  danger: isDark ? '#ff453a' : '#ff3b30',
  
  // Special
  inputBg: isDark ? '#1c1c1e' : '#f9f9f9',
  buttonSecondaryBg: isDark ? '#2c2c2e' : '#e5e5ea',
  buttonSecondaryText: isDark ? '#f5f5f7' : '#1d1d1f',
});

// ─── Styles ───────────────────────────────────────────────────────────────────
const S = {
  page: {
    minHeight: '100vh',
    background: '#0f0f0f',
    color: '#fff',
    padding: '1.5rem',
    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
    boxSizing: 'border-box' as const,
    width: '100%',
    overflowX: 'hidden' as const,
    wordBreak: 'break-word' as const,
  } as React.CSSProperties,
  centered: {
    display: 'flex',
    flexDirection: 'column' as const,
    alignItems: 'center',
    justifyContent: 'center',
  },
  btn: (color = '#333') => ({
    background: color,
    color: '#fff',
    border: 'none',
    padding: '0.9rem 1.2rem',
    fontSize: '1.05rem',
    borderRadius: '14px',
    cursor: 'pointer',
    width: '100%',
    marginBottom: '0.75rem',
    fontWeight: 600,
    letterSpacing: '0.01em',
  } as React.CSSProperties),
  card: (bg = '#1a1a1a') => ({
    background: bg,
    padding: '1rem 1.2rem',
    borderRadius: '14px',
    marginBottom: '0.8rem',
    boxSizing: 'border-box' as const,
    width: '100%',
    wordBreak: 'break-word' as const,
    overflowWrap: 'break-word' as const,
  } as React.CSSProperties),
  tag: (color: string) => ({
    display: 'inline-block',
    background: color,
    color: '#fff',
    fontSize: '0.75rem',
    padding: '2px 8px',
    borderRadius: '8px',
    marginBottom: '6px',
    fontWeight: 700,
  } as React.CSSProperties),
};

// ─── Ачивки ───────────────────────────────────────────────────────────────────
interface Achievement {
  id: string;
  emoji: string;
  title: string;
  desc: string;
  check: (s: UserState) => boolean;
}

const ACHIEVEMENTS: Achievement[] = [
  { id: 'first_step',   emoji: '👣', title: 'Первый шаг',       desc: 'Выполнить первый день',                  check: s => s.completedDays.length >= 1 },
  { id: 'streak_3',     emoji: '🔥', title: 'Три дня подряд',   desc: 'Не пропустить 3 дня подряд',             check: s => s.maxStreak >= 3 },
  { id: 'week_done',    emoji: '📅', title: 'Неделя',           desc: 'Выполнить 7 дней плана',                 check: s => s.completedDays.length >= 7 },
  { id: 'streak_7',     emoji: '⚡', title: 'Огонь недели',      desc: '7 дней подряд без пропуска',             check: s => s.maxStreak >= 7 },
  { id: 'two_weeks',    emoji: '🌱', title: 'Росток',           desc: 'Выполнить 14 дней плана',                check: s => s.completedDays.length >= 14 },
  { id: 'month_done',   emoji: '🌙', title: 'Первый месяц',     desc: 'Выполнить 30 дней плана',                check: s => s.completedDays.length >= 30 },
  { id: 'streak_14',    emoji: '💪', title: 'Две недели огня',   desc: '14 дней подряд без пропуска',            check: s => s.maxStreak >= 14 },
  { id: 'halfway',      emoji: '🎯', title: 'Половина пути',    desc: 'Выполнить 45 дней плана',                check: s => s.completedDays.length >= 45 },
  { id: 'two_months',   emoji: '🦋', title: 'Два месяца',       desc: 'Выполнить 60 дней плана',                check: s => s.completedDays.length >= 60 },
  { id: 'streak_30',    emoji: '🌊', title: 'Месяц без пропусков', desc: '30 дней подряд',                     check: s => s.maxStreak >= 30 },
  { id: 'journal_10',   emoji: '📓', title: 'Летописец',        desc: 'Сделать 10 записей в журнале',           check: s => s.journalEntries.length >= 10 },
  { id: 'journal_50',   emoji: '📖', title: 'Хроникёр',         desc: 'Сделать 50 записей в журнале',           check: s => s.journalEntries.length >= 50 },
  { id: 'test_done',    emoji: '🧭', title: 'Честный взгляд',   desc: 'Пройти тест осознанности',               check: s => s.testDone },
  { id: 'day_75',       emoji: '🏔️', title: 'Почти вершина',    desc: 'Выполнить 75 дней плана',                check: s => s.completedDays.length >= 75 },
  { id: 'finished',     emoji: '🏆', title: 'Завершение',       desc: 'Пройти все 90 дней',                     check: s => s.completedDays.length >= 90 },
];

function getUnlockedAchievements(state: UserState): Achievement[] {
  return ACHIEVEMENTS.filter(a => a.check(state));
}

function getNewAchievements(prev: UserState, next: UserState): Achievement[] {
  const wasDone = new Set(getUnlockedAchievements(prev).map(a => a.id));
  return getUnlockedAchievements(next).filter(a => !wasDone.has(a.id));
}

// ─── Screen types ─────────────────────────────────────────────────────────────
type Screen = 'home' | 'test' | 'result' | 'plan' | 'journal' | 'day-detail' | 'task-journal' | 'motivation' | 'achievements' | 'stats' | 'planner';

// ═════════════════════════════════════════════════════════════════════════════
export default function App() {
  const rawInitData = useRawInitData();
  const [screen, setScreen] = useState<Screen>('home');
  const [userId, setUserId] = useState('guest');
  const [userName, setUserName] = useState('');
  const [userState, setUserState] = useState<UserState>(DEFAULT_STATE);

  const [testStep, setTestStep] = useState(0);
  const [testScore, setTestScore] = useState(0);

  // Активный день (для day-detail и task-journal)
  const [activeDay, setActiveDay] = useState<number>(1);
  // Активный индекс задания (0,1,2)
  const [activeTaskIdx, setActiveTaskIdx] = useState<number>(0);
  const [taskDraft, setTaskDraft] = useState('');

  const [motivationMsg, setMotivationMsg] = useState(motivationMessages[0]);
  const [completedDayNum, setCompletedDayNum] = useState(1);

  const [journalDraft, setJournalDraft] = useState('');
  const [resetConfirm, setResetConfirm] = useState(false);
  const [newAchievements, setNewAchievements] = useState<Achievement[]>([]);
  const [lessonOpen, setLessonOpen] = useState(false);
  
  // Planner state
  const [plannerTab, setPlannerTab] = useState<'day' | 'week'>('day');
  const [taskDraftPlanner, setTaskDraftPlanner] = useState('');
  const [taskPriority, setTaskPriority] = useState<'high' | 'medium' | 'low'>('medium');
  const [taskTime, setTaskTime] = useState('');
  const [weekGoalDraft, setWeekGoalDraft] = useState('');

  // ── Init ────────────────────────────────────────────────────────────────────
  useEffect(() => { try { init(); } catch {} }, []);

  useEffect(() => {
    let uid = 'guest'; let uname = '';
    if (rawInitData) {
      try {
        const params = new URLSearchParams(rawInitData);
        const userJson = params.get('user');
        if (userJson) {
          const user = JSON.parse(decodeURIComponent(userJson));
          uid = String(user.id || 'guest');
          uname = user.first_name || '';
        }
      } catch (e) { console.error(e); }
    }
    setUserId(uid); setUserName(uname);
    setUserState(loadState(uid));
  }, [rawInitData]);

  function updateState(patch: Partial<UserState>) {
    setUserState(prev => {
      const next = { ...prev, ...patch };
      saveState(userId, next);
      return next;
    });
  }

  // ── Test ────────────────────────────────────────────────────────────────────
  function handleTestAnswer(points: number) {
    const ns = testScore + points;
    setTestScore(ns);
    if (testStep + 1 >= questions.length) {
      updateState({ testDone: true, testScore: ns });
      setScreen('result');
    } else { setTestStep(s => s + 1); }
  }
  function startTest() { setTestStep(0); setTestScore(0); setScreen('test'); }

  // ── Navigation ──────────────────────────────────────────────────────────────
  function openDay(day: number) { setActiveDay(day); setLessonOpen(false); setScreen('day-detail'); }

  function openTaskJournal(day: number, taskIdx: number) {
    setActiveDay(day); setActiveTaskIdx(taskIdx);
    setTaskDraft(''); setScreen('task-journal');
  }

  // ── Save task entry ─────────────────────────────────────────────────────────
  function saveTaskEntry() {
    if (!taskDraft.trim()) return;
    const entry: JournalEntry = {
      id: Date.now().toString(),
      date: new Date().toLocaleString('ru-RU'),
      text: taskDraft.trim(),
      day: activeDay,
      taskIdx: activeTaskIdx,
    };
    const newEntries = [...userState.journalEntries, entry];

    // Проверяем, закрывает ли эта запись весь день
    const doneAfter = [0, 1, 2].filter(i => {
      if (i === activeTaskIdx) return true;
      return isTaskDone(userState.journalEntries, activeDay, i);
    });
    const dayNowComplete = doneAfter.length === 3;
    const wasAlreadyComplete = userState.completedDays.includes(activeDay);

    const newCompleted = dayNowComplete && !wasAlreadyComplete
      ? [...userState.completedDays, activeDay]
      : userState.completedDays;

    const nextDay = dayNowComplete && !wasAlreadyComplete && activeDay >= userState.currentDay
      ? Math.min(90, activeDay + 1)
      : userState.currentDay;

    const newStreak = dayNowComplete && !wasAlreadyComplete
      ? calcNewStreak(userState.lastCompletedDate, userState.currentStreak)
      : userState.currentStreak;
    const newMaxStreak = Math.max(userState.maxStreak, newStreak);

    updateState({
      journalEntries: newEntries,
      completedDays: newCompleted,
      currentDay: nextDay,
      lastCompletedDate: dayNowComplete && !wasAlreadyComplete ? getTodayString() : userState.lastCompletedDate,
      currentStreak: newStreak,
      maxStreak: newMaxStreak,
    });

    setTaskDraft('');

    // Проверяем новые ачивки
    const nextState: UserState = {
      ...userState,
      journalEntries: newEntries,
      completedDays: newCompleted,
      currentDay: nextDay,
      lastCompletedDate: dayNowComplete && !wasAlreadyComplete ? getTodayString() : userState.lastCompletedDate,
      currentStreak: newStreak,
      maxStreak: newMaxStreak,
    };
    const newAch = getNewAchievements(userState, nextState);

    if (dayNowComplete && !wasAlreadyComplete) {
      const randMsg = motivationMessages[Math.floor(Math.random() * motivationMessages.length)];
      setMotivationMsg(randMsg);
      setCompletedDayNum(activeDay);
      setNewAchievements(newAch);
      setScreen('motivation');
    } else {
      if (newAch.length > 0) setNewAchievements(newAch);
      setScreen('day-detail');
    }
  }

  // ── Free journal ────────────────────────────────────────────────────────────
  function saveFreeEntry() {
    if (!journalDraft.trim()) return;
    const entry: JournalEntry = { id: Date.now().toString(), date: new Date().toLocaleString('ru-RU'), text: journalDraft.trim() };
    updateState({ journalEntries: [...userState.journalEntries, entry] });
    setJournalDraft('');
  }
  function deleteEntry(id: string) {
    updateState({ journalEntries: userState.journalEntries.filter(e => e.id !== id) });
  }
  function resetAll() {
    const fresh = { ...DEFAULT_STATE };
    saveState(userId, fresh);
    setUserState(fresh);
    setScreen('home');
  }

  function resultLabel(s: number) {
    if (s <= 8) return { text: 'Низкий уровень — круто, ты уже умеешь ставить границы! Задания помогут укрепить этот навык!', color: 'c.success' };
    if (s <= 16) return { text: 'Средний уровень — есть над чем поработать. Давай перейдем к практике!', color: '#ff9800' };
    return { text: 'Высокий уровень — пора менять подход. Давай перейдем к практике!', color: '#ff4444' };
  }

  // ════════════════════════════════════════════════════════════════════════════
  // HOME
  // ════════════════════════════════════════════════════════════════════════════
  if (screen === 'home') {
    const greeting = userName ? `Привет, ${userName}!` : 'Привет!';
    const res = userState.testDone ? resultLabel(userState.testScore) : null;
    const dailyQuote = getDailyQuote(userState.currentDay);
    const today = getTodayString();
    const yesterday = getYesterdayString();
    const streakAlive = userState.currentStreak > 0 &&
      (userState.lastCompletedDate === today || userState.lastCompletedDate === yesterday);
    const displayStreak = streakAlive ? userState.currentStreak : 0;
    const c = getColors(userState.theme === 'dark');

    return (
      <div style={{ minHeight: '100vh', background: c.bg, color: c.text, padding: '1.5rem', fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif', transition: 'background 0.3s ease', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' }}>
        {/* Theme toggle */}
        <button
          onClick={() => updateState({ theme: userState.theme === 'light' ? 'dark' : 'light' })}
          style={{ position: 'absolute', top: '1rem', right: '1rem', background: c.card, border: `1px solid ${c.border}`, borderRadius: '12px', width: 44, height: 44, display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', fontSize: '1.3rem', boxShadow: userState.theme === 'light' ? '0 2px 8px rgba(0,0,0,0.08)' : '0 2px 8px rgba(0,0,0,0.4)', transition: 'all 0.2s ease' }}>
          {userState.theme === 'light' ? '🌙' : '☀️'}
        </button>

        <img src="https://i.ibb.co/0RR9w3Gq/image.jpg" alt="Обложка"
          style={{ maxWidth: '280px', borderRadius: '20px', marginBottom: '1.5rem', boxShadow: userState.theme === 'light' ? '0 8px 24px rgba(0,0,0,0.12)' : '0 8px 24px rgba(0,0,0,0.6)' }} />
        <h1 style={{ fontSize: '2.8rem', color: c.accent, margin: '0 0 0.3rem', fontWeight: 700, letterSpacing: '-0.02em' }}>НеДляВсех</h1>
        <p style={{ fontSize: '1.4rem', margin: '0 0 1.2rem', color: c.textSec, fontWeight: 500 }}>{greeting}</p>

        {userState.completedDays.length > 0 && (
          <div style={{ display: 'flex', gap: '0.8rem', marginBottom: '1.2rem', width: '100%', maxWidth: 400 }}>
            <div style={{ flex: 1, background: c.card, border: `1px solid ${c.border}`, borderRadius: '16px', padding: '1rem', textAlign: 'center', boxShadow: userState.theme === 'light' ? '0 2px 8px rgba(0,0,0,0.08)' : '0 2px 8px rgba(0,0,0,0.4)' }}>
              <div style={{ fontSize: '2rem', marginBottom: '4px' }}>{displayStreak > 0 ? '🔥' : '💤'}</div>
              <div style={{ fontSize: '1.8rem', fontWeight: 700, color: displayStreak > 0 ? '#ff8c42' : c.textSec, lineHeight: 1, letterSpacing: '-0.02em' }}>{displayStreak}</div>
              <div style={{ fontSize: '0.7rem', color: c.textSec, marginTop: 4, fontWeight: 500 }}>{displayStreak === 1 ? 'день подряд' : displayStreak >= 2 && displayStreak <= 4 ? 'дня подряд' : 'дней подряд'}</div>
            </div>
            <div style={{ flex: 1, background: c.card, border: `1px solid ${c.border}`, borderRadius: '16px', padding: '1rem', textAlign: 'center', boxShadow: userState.theme === 'light' ? '0 2px 8px rgba(0,0,0,0.08)' : '0 2px 8px rgba(0,0,0,0.4)' }}>
              <div style={{ fontSize: '2rem', marginBottom: '4px' }}>🏆</div>
              <div style={{ fontSize: '1.8rem', fontWeight: 700, color: c.accent, lineHeight: 1, letterSpacing: '-0.02em' }}>{userState.maxStreak}</div>
              <div style={{ fontSize: '0.7rem', color: c.textSec, marginTop: 4, fontWeight: 500 }}>рекорд</div>
            </div>
            <div style={{ flex: 1, background: c.card, border: `1px solid ${c.border}`, borderRadius: '16px', padding: '1rem', textAlign: 'center', boxShadow: userState.theme === 'light' ? '0 2px 8px rgba(0,0,0,0.08)' : '0 2px 8px rgba(0,0,0,0.4)' }}>
              <div style={{ fontSize: '2rem', marginBottom: '4px' }}>✅</div>
              <div style={{ fontSize: '1.8rem', fontWeight: 700, color: c.success, lineHeight: 1, letterSpacing: '-0.02em' }}>{userState.completedDays.length}</div>
              <div style={{ fontSize: '0.7rem', color: c.textSec, marginTop: 4, fontWeight: 500 }}>из 90</div>
            </div>
          </div>
        )}

        {userState.testDone && res ? (
          <div style={{ background: c.card, border: `1px solid ${c.border}`, borderRadius: '16px', padding: '1.2rem', width: '100%', maxWidth: 400, marginBottom: '1.2rem', textAlign: 'center', boxShadow: userState.theme === 'light' ? '0 2px 8px rgba(0,0,0,0.08)' : '0 2px 8px rgba(0,0,0,0.4)' }}>
            <div style={{ fontSize: '0.7rem', color: c.accent, fontWeight: 600, letterSpacing: '0.05em', textTransform: 'uppercase', marginBottom: '0.5rem' }}>Твой результат</div>
            <p style={{ fontSize: '2rem', fontWeight: 700, margin: '0.3rem 0', color: c.text, letterSpacing: '-0.02em' }}>{userState.testScore} баллов</p>
            <p style={{ fontSize: '0.95rem', color: c.textSec, margin: 0, lineHeight: 1.4 }}>{res.text}</p>
          </div>
        ) : userState.completedDays.length === 0 ? (
          <p style={{ fontSize: '1rem', maxWidth: '90%', textAlign: 'center', color: c.textSec, marginBottom: '1.2rem', lineHeight: 1.6 }}>
            Берёшь на себя чужие ожидания?<br />
            Постоянно отдаёшь, чтобы понравиться?<br />
            Пора стать для себя.<br />
            <span style={{ color: c.accent, fontWeight: 600 }}>Пройди тест честно!</span>
          </p>
        ) : null}

        {/* Цитата дня */}
        <div style={{ width: '100%', maxWidth: 400, background: c.card, border: `1px solid ${c.border}`, borderRadius: '16px', padding: '1.2rem', marginBottom: '1.2rem', boxShadow: userState.theme === 'light' ? '0 2px 8px rgba(0,0,0,0.08)' : '0 2px 8px rgba(0,0,0,0.4)' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.6rem' }}>
            <span style={{ fontSize: '0.7rem', color: c.accent, fontWeight: 600, letterSpacing: '0.05em', textTransform: 'uppercase' }}>💬 День {userState.currentDay}</span>
            <span style={{ fontSize: '0.65rem', color: c.textSec, background: c.inputBg, padding: '2px 8px', borderRadius: '6px', fontWeight: 500 }}>{dailyQuote.context}</span>
          </div>
          <p style={{ margin: 0, fontSize: '0.95rem', color: c.text, lineHeight: 1.6, fontStyle: 'italic' }}>{dailyQuote.text}</p>
        </div>

        <div style={{ width: '100%', maxWidth: 400 }}>
          {!userState.testDone
            ? <button style={{ background: c.accent, color: c.text, border: 'none', padding: '0.95rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', marginBottom: '0.7rem', fontWeight: 600, letterSpacing: '-0.01em', boxShadow: '0 2px 8px rgba(0,122,255,0.25)', transition: 'all 0.2s ease' }} onClick={startTest}>Пройти тест</button>
            : <button style={{ background: c.inputBg, color: c.text, border: `1px solid ${c.border}`, padding: '0.95rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', marginBottom: '0.7rem', fontWeight: 600, letterSpacing: '-0.01em', transition: 'all 0.2s ease' }} onClick={startTest}>Пройти тест заново</button>}
          
          <button style={{ background: c.accent, color: c.text, border: 'none', padding: '0.95rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', marginBottom: '0.7rem', fontWeight: 600, letterSpacing: '-0.01em', display: 'flex', alignItems: 'center', justifyContent: 'space-between', boxShadow: '0 2px 8px rgba(0,122,255,0.25)' }} onClick={() => setScreen('plan')}>
            <span>📅 90-дневный план</span>
            {userState.completedDays.length > 0 && <span style={{ opacity: 0.8, fontWeight: 500, fontSize: '0.9rem' }}>({userState.completedDays.length}/90)</span>}
          </button>
          
          <button style={{ background: c.accent, color: c.text, border: 'none', padding: '0.95rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', marginBottom: '0.7rem', fontWeight: 600, letterSpacing: '-0.01em', display: 'flex', alignItems: 'center', justifyContent: 'space-between', boxShadow: '0 2px 8px rgba(0,122,255,0.25)' }} onClick={() => { setPlannerTab('day'); setScreen('planner'); }}>
            <span>📋 Планирование</span>
            {(userState.dailyTasks.length > 0 || userState.weeklyGoals.length > 0) && (
              <span style={{ opacity: 0.8, fontWeight: 500, fontSize: '0.9rem' }}>({userState.dailyTasks.filter(t => t.done).length}/{userState.dailyTasks.length})</span>
            )}
          </button>
          
          <button style={{ background: c.accent, color: c.text, border: 'none', padding: '0.95rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', marginBottom: '0.7rem', fontWeight: 600, letterSpacing: '-0.01em', display: 'flex', alignItems: 'center', justifyContent: 'space-between', boxShadow: '0 2px 8px rgba(0,122,255,0.25)' }} onClick={() => setScreen('journal')}>
            <span>📓 Журнал записей</span>
            {userState.journalEntries.length > 0 && <span style={{ opacity: 0.8, fontWeight: 500, fontSize: '0.9rem' }}>({userState.journalEntries.length})</span>}
          </button>
          
          <button style={{ background: c.accent, color: c.text, border: 'none', padding: '0.95rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', marginBottom: '0.7rem', fontWeight: 600, letterSpacing: '-0.01em', display: 'flex', alignItems: 'center', justifyContent: 'space-between', boxShadow: '0 2px 8px rgba(0,122,255,0.25)' }} onClick={() => setScreen('achievements')}>
            <span>🏅 Ачивки</span>
            <span style={{ opacity: 0.8, fontWeight: 500, fontSize: '0.9rem' }}>({getUnlockedAchievements(userState).length}/{ACHIEVEMENTS.length})</span>
          </button>
          
          <button style={{ background: c.accent, color: c.text, border: 'none', padding: '0.95rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', marginBottom: '0.7rem', fontWeight: 600, letterSpacing: '-0.01em', boxShadow: '0 2px 8px rgba(0,122,255,0.25)' }} onClick={() => setScreen('stats')}>
            📊 Статистика
          </button>
        </div>
      </div>
    );
  }
  // ════════════════════════════════════════════════════════════════════════════
  // TEST
  // ════════════════════════════════════════════════════════════════════════════
  if (screen === 'test') {
    const q = questions[testStep];
    const progress = Math.round((testStep / questions.length) * 100);
    const c = getColors(userState.theme === 'dark');
    
    return (
      <div style={{ minHeight: '100vh', background: c.bg, color: c.text, padding: '1.5rem', fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' }}>
        <div style={{ width: '100%', maxWidth: 400, marginBottom: '2rem' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.8rem', color: c.textSec, marginBottom: 8, fontWeight: 500 }}>
            <span>Вопрос {testStep + 1} из {questions.length}</span><span>{progress}%</span>
          </div>
          <div style={{ background: userState.theme === 'light' ? '#e5e5ea' : '#2c2c2e', borderRadius: 8, height: 6 }}>
            <div style={{ background: c.accent, width: `${progress}%`, height: 6, borderRadius: 8, transition: 'width 0.3s ease' }} />
          </div>
        </div>
        <p style={{ fontSize: '1.4rem', maxWidth: 400, textAlign: 'center', margin: '0 0 2rem', lineHeight: 1.5, fontWeight: 600, letterSpacing: '-0.01em' }}>{q.q}</p>
        <div style={{ width: '100%', maxWidth: 400 }}>
          <button style={{ background: c.accent, color: c.text, border: 'none', padding: '1rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', marginBottom: '0.7rem', fontWeight: 600, letterSpacing: '-0.01em', boxShadow: '0 2px 8px rgba(0,122,255,0.25)' }} onClick={() => handleTestAnswer(2)}>Да, часто</button>
          <button style={{ background: c.buttonSecondaryBg, color: c.buttonSecondaryText, border: `1px solid ${c.border}`, padding: '1rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', marginBottom: '0.7rem', fontWeight: 600, letterSpacing: '-0.01em' }} onClick={() => handleTestAnswer(1)}>Иногда</button>
          <button style={{ background: c.buttonSecondaryBg, color: c.buttonSecondaryText, border: `1px solid ${c.border}`, padding: '1rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', marginBottom: '0.7rem', fontWeight: 600, letterSpacing: '-0.01em' }} onClick={() => handleTestAnswer(0)}>Нет, редко</button>
        </div>
        <button style={{ background: 'none', border: 'none', color: c.textSec, cursor: 'pointer', marginTop: '1rem', fontSize: '1rem', fontWeight: 500 }} onClick={() => setScreen('home')}>← Назад</button>
      </div>
    );
  }

  // ════════════════════════════════════════════════════════════════════════════
  // RESULT
  // ════════════════════════════════════════════════════════════════════════════
  if (screen === 'result') {
    const res = resultLabel(userState.testScore);
    const c = getColors(userState.theme === 'dark');
    
    return (
      <div style={{ minHeight: '100vh', background: c.bg, color: c.text, padding: '1.5rem', fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' }}>
        <h1 style={{ fontSize: '2rem', marginBottom: '1rem', fontWeight: 700, letterSpacing: '-0.02em' }}>Результат теста</h1>
        <div style={{ fontSize: '4.5rem', fontWeight: 800, color: c.accent, margin: '0.5rem 0', letterSpacing: '-0.03em' }}>{userState.testScore}</div>
        <p style={{ fontSize: '0.9rem', color: c.textSec, marginBottom: '0.5rem', fontWeight: 500 }}>баллов из 24</p>
        <p style={{ fontSize: '1.15rem', textAlign: 'center', maxWidth: 340, margin: '1rem 0 2rem', color: c.text, lineHeight: 1.5 }}>{res.text}</p>
        <div style={{ width: '100%', maxWidth: 400 }}>
          <button style={{ background: c.accent, color: c.text, border: 'none', padding: '1rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', marginBottom: '0.7rem', fontWeight: 600, letterSpacing: '-0.01em', boxShadow: '0 2px 8px rgba(0,122,255,0.25)' }} onClick={() => setScreen('plan')}>📅 Начать 90-дневный план</button>
          <button style={{ background: c.accent, color: c.text, border: 'none', padding: '1rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', marginBottom: '0.7rem', fontWeight: 600, letterSpacing: '-0.01em', boxShadow: '0 2px 8px rgba(0,122,255,0.25)' }} onClick={() => setScreen('journal')}>📓 Открыть журнал</button>
          <button style={{ background: c.buttonSecondaryBg, color: c.buttonSecondaryText, border: `1px solid ${c.border}`, padding: '1rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', marginBottom: '0.7rem', fontWeight: 600, letterSpacing: '-0.01em' }} onClick={() => setScreen('home')}>На главную</button>
        </div>
      </div>
    );
  }
  // ════════════════════════════════════════════════════════════════════════════
  // ════════════════════════════════════════════════════════════════════════════
  // MOTIVATION
  // ════════════════════════════════════════════════════════════════════════════
  if (screen === 'motivation') {
    const totalDone = userState.completedDays.length;
    const streak = userState.currentStreak;
    const c = getColors(userState.theme === 'dark');

    return (
      <div style={{ minHeight: '100vh', background: c.bg, color: c.text, padding: '1.5rem', fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', textAlign: 'center' }}>
        <div style={{ fontSize: '5rem', marginBottom: '1rem' }}>{motivationMsg.emoji}</div>
        <div style={{ background: c.card, border: `1px solid ${c.border}`, borderRadius: '20px', padding: '2rem 1.5rem', maxWidth: 360, width: '100%', marginBottom: '1.2rem', boxShadow: userState.theme === 'light' ? '0 4px 16px rgba(0,0,0,0.1)' : '0 4px 16px rgba(0,0,0,0.5)' }}>
          <div style={{ display: 'inline-block', background: `${c.accent}15`, border: `1px solid ${c.accent}40`, borderRadius: '10px', padding: '4px 12px', fontSize: '0.75rem', color: c.accent, fontWeight: 700, marginBottom: '0.8rem', letterSpacing: '0.05em' }}>ДЕНЬ {completedDayNum} ЗАКРЫТ ✓</div>
          <h2 style={{ fontSize: '2rem', fontWeight: 800, margin: '0 0 0.8rem', color: c.text, letterSpacing: '-0.02em' }}>{motivationMsg.title}</h2>
          <p style={{ fontSize: '1.05rem', color: c.textSec, lineHeight: 1.6, margin: 0 }}>{motivationMsg.text}</p>
        </div>
        <div style={{ display: 'flex', gap: '0.8rem', width: '100%', maxWidth: 360, marginBottom: '1.5rem' }}>
          <div style={{ flex: 1, background: c.card, border: `1px solid ${c.border}`, borderRadius: '16px', padding: '1rem 0.5rem', textAlign: 'center', boxShadow: userState.theme === 'light' ? '0 2px 8px rgba(0,0,0,0.08)' : '0 2px 8px rgba(0,0,0,0.4)' }}>
            <div style={{ fontSize: '1.8rem' }}>🔥</div>
            <div style={{ fontSize: '1.8rem', fontWeight: 800, color: '#ff8c42', lineHeight: 1.1, letterSpacing: '-0.02em' }}>{streak}</div>
            <div style={{ fontSize: '0.68rem', color: c.textSec, marginTop: 2, fontWeight: 500 }}>{streak === 1 ? 'день подряд' : streak >= 2 && streak <= 4 ? 'дня подряд' : 'дней подряд'}</div>
          </div>
          <div style={{ flex: 2, background: c.card, border: `1px solid ${c.border}`, borderRadius: '16px', padding: '1rem', boxShadow: userState.theme === 'light' ? '0 2px 8px rgba(0,0,0,0.08)' : '0 2px 8px rgba(0,0,0,0.4)' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 8 }}>
              <span style={{ fontSize: '0.8rem', color: c.textSec, fontWeight: 500 }}>Прогресс</span>
              <span style={{ fontSize: '0.8rem', fontWeight: 700, color: c.success }}>{totalDone} / 90</span>
            </div>
            <div style={{ background: userState.theme === 'light' ? '#e5e5ea' : '#2c2c2e', borderRadius: 8, height: 6 }}>
              <div style={{ background: c.success, width: `${Math.round((totalDone / 90) * 100)}%`, height: 6, borderRadius: 8, minWidth: totalDone > 0 ? 6 : 0, transition: 'width 0.3s ease' }} />
            </div>
            <p style={{ margin: '0.6rem 0 0', fontSize: '0.75rem', color: c.textSec, textAlign: 'center', fontWeight: 500 }}>🗓 Возвращайся завтра!</p>
          </div>
        </div>
        <div style={{ width: '100%', maxWidth: 360 }}>
          {newAchievements.length > 0 && (
            <div style={{ background: c.card, border: `1px solid ${c.border}`, borderRadius: '16px', padding: '1rem 1.2rem', marginBottom: '0.8rem', boxShadow: userState.theme === 'light' ? '0 2px 8px rgba(0,0,0,0.08)' : '0 2px 8px rgba(0,0,0,0.4)' }}>
              <p style={{ margin: '0 0 0.8rem', fontSize: '0.75rem', color: c.accent, fontWeight: 700, letterSpacing: '0.06em', textTransform: 'uppercase' }}>🏅 Новая ачивка!</p>
              {newAchievements.map(a => (
                <div key={a.id} style={{ display: 'flex', alignItems: 'center', gap: '0.8rem' }}>
                  <span style={{ fontSize: '1.8rem' }}>{a.emoji}</span>
                  <div>
                    <p style={{ margin: 0, fontWeight: 700, fontSize: '1rem', color: c.text }}>{a.title}</p>
                    <p style={{ margin: 0, fontSize: '0.82rem', color: c.textSec }}>{a.desc}</p>
                  </div>
                </div>
              ))}
            </div>
          )}
          <button style={{ background: c.accent, color: '#fff', border: 'none', padding: '1rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', marginBottom: '0.7rem', fontWeight: 600, letterSpacing: '-0.01em', boxShadow: '0 2px 8px rgba(0,122,255,0.25)' }} onClick={() => { setNewAchievements([]); setScreen('plan'); }}>📅 К плану</button>
          <button style={{ background: c.buttonSecondaryBg, color: c.buttonSecondaryText, border: `1px solid ${c.border}`, padding: '1rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', fontWeight: 600, letterSpacing: '-0.01em' }} onClick={() => { setNewAchievements([]); setScreen('home'); }}>На главную</button>
        </div>
      </div>
    );
  }

  // ════════════════════════════════════════════════════════════════════════════
  // ACHIEVEMENTS
  // ════════════════════════════════════════════════════════════════════════════
  if (screen === 'achievements') {
    const unlocked = getUnlockedAchievements(userState);
    const unlockedIds = new Set(unlocked.map(a => a.id));

    const c = getColors(userState.theme === 'dark');

    return (
      <div style={{ minHeight: '100vh', background: c.bg, color: c.text, padding: '1.5rem', fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' }}>
        <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
          <button style={{ background: 'none', border: 'none', color: c.textSec, cursor: 'pointer', fontSize: '1.2rem', marginRight: 8 }} onClick={() => setScreen('home')}>←</button>
          <h1 style={{ margin: 0, fontSize: '1.5rem' }}>Ачивки</h1>
        </div>

        {/* Прогресс */}
        <div style={{ ...S.card('#1a1a2a'), marginBottom: '1.2rem', textAlign: 'center' }}>
          <p style={{ margin: '0 0 8px', fontWeight: 700, fontSize: '1.1rem' }}>
            {unlocked.length} <span style={{ color: c.textSec, fontWeight: 400 }}>из</span> {ACHIEVEMENTS.length}
          </p>
          <div style={{ background: c.card, borderRadius: 8, height: 8 }}>
            <div style={{ background: 'linear-gradient(90deg,c.accent,#a855f7)', width: `${Math.round((unlocked.length / ACHIEVEMENTS.length) * 100)}%`, height: 8, borderRadius: 8, transition: 'width 0.4s', minWidth: unlocked.length > 0 ? 8 : 0 }} />
          </div>
        </div>

        {/* Список */}
        {ACHIEVEMENTS.map(a => {
          const done = unlockedIds.has(a.id);
          return (
            <div key={a.id} style={{ ...S.card(done ? '#1a1a2a' : '#111'), border: `1px solid ${done ? '#3a2a5a' : '#1a1a1a'}`, opacity: done ? 1 : 0.45 }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                <div style={{ fontSize: '2.2rem', filter: done ? 'none' : 'grayscale(1)', flexShrink: 0 }}>{a.emoji}</div>
                <div style={{ flex: 1 }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 2 }}>
                    <span style={{ fontWeight: 700, fontSize: '1rem' }}>{a.title}</span>
                    {done && <span style={S.tag('c.accent')}>✓</span>}
                  </div>
                  <p style={{ margin: 0, fontSize: '0.85rem', color: done ? '#aaa' : '#555' }}>{a.desc}</p>
                </div>
              </div>
            </div>
          );
        })}

        <button style={{ ...S.btn('#333'), marginTop: '1rem' }} onClick={() => setScreen('home')}>На главную</button>
      </div>
    );
  }

  // ════════════════════════════════════════════════════════════════════════════
  // PLAN — список 90 дней
  // ════════════════════════════════════════════════════════════════════════════
  if (screen === 'plan') {
    const completed = userState.completedDays.length;
    const progressPct = Math.round((completed / 90) * 100);

    const c = getColors(userState.theme === 'dark');

    return (
      <div style={{ minHeight: '100vh', background: c.bg, color: c.text, padding: '1.5rem', fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' }}>
        <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
          <button style={{ background: 'none', border: 'none', color: c.textSec, cursor: 'pointer', fontSize: '1.2rem', marginRight: 8 }} onClick={() => setScreen('home')}>←</button>
          <h1 style={{ margin: 0, fontSize: '1.5rem' }}>90-дневный план</h1>
        </div>

        <div style={{ ...S.card('#1a2a1a'), marginBottom: '1.2rem' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 6 }}>
            <span style={{ fontWeight: 700 }}>Прогресс</span>
            <span style={{ color: 'c.success', fontWeight: 700 }}>{completed} / 90</span>
          </div>
          <div style={{ background: c.card, borderRadius: 8, height: 8 }}>
            <div style={{ background: 'c.success', width: `${progressPct}%`, height: 8, borderRadius: 8 }} />
          </div>
          <p style={{ margin: '0.5rem 0 0', fontSize: '0.85rem', color: c.textSec }}>Текущий день: {userState.currentDay}</p>
        </div>

        {Array.from({ length: 90 }, (_, i) => i + 1).map(day => {
          const isDone = userState.completedDays.includes(day);
          const isCurrent = day === userState.currentDay;
          const progress = dayProgress(userState.journalEntries, day);
          const dayData = dailyPlan[day - 1];
          if (!dayData) return null; // защита от краша

          return (
            <div key={day} style={{ ...S.card(isDone ? '#1a2e1a' : isCurrent ? '#1a2040' : '#1a1a1a'), border: isCurrent ? '1px solid c.accent44' : '1px solid transparent', cursor: 'pointer' }}
              onClick={() => openDay(day)}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: 8 }}>
                <div style={{ flex: 1, minWidth: 0 }}>
                  <div style={{ display: 'flex', gap: 6, flexWrap: 'wrap', marginBottom: 4 }}>
                    {isCurrent && <span style={S.tag('c.accent')}>Сегодня</span>}
                    {isDone && <span style={S.tag('c.success')}>✓ Выполнен</span>}
                    {!isDone && progress > 0 && <span style={S.tag('#ff9800')}>{progress}/3</span>}
                  </div>
                  <p style={{ margin: 0, fontSize: '0.95rem', lineHeight: 1.4 }}>
                    <span style={{ color: c.accent, fontWeight: 700, marginRight: 6 }}>День {day}.</span>
                    {dayData.theme}
                  </p>
                </div>
                <div style={{ color: c.textSec, fontSize: '1.2rem', flexShrink: 0 }}>›</div>
              </div>
              <div style={{ display: 'flex', gap: 4, marginTop: 8 }}>
                {[0, 1, 2].map(i => (
                  <div key={i} style={{ flex: 1, height: 4, borderRadius: 2, background: isTaskDone(userState.journalEntries, day, i) ? 'c.success' : '#2a2a2a' }} />
                ))}
              </div>
            </div>
          );
        })}

        <button style={{ ...S.btn('#333'), marginTop: '1rem' }} onClick={() => setScreen('home')}>На главную</button>
      </div>
    );
  }

  // ════════════════════════════════════════════════════════════════════════════
  // DAY DETAIL — 3 задания дня
  // ════════════════════════════════════════════════════════════════════════════
  if (screen === 'day-detail') {
    const dayData = dailyPlan[activeDay - 1];
    const isDayDone = userState.completedDays.includes(activeDay);
    const taskLabels = ['🔵 Практика', '👁 Наблюдение', '✍️ Рефлексия'];

    const c = getColors(userState.theme === 'dark');

    return (
      <div style={{ minHeight: '100vh', background: c.bg, color: c.text, padding: '1.5rem', fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' }}>
        <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
          <button style={{ background: 'none', border: 'none', color: c.textSec, cursor: 'pointer', fontSize: '1.2rem', marginRight: 8 }} onClick={() => setScreen('plan')}>←</button>
          <h2 style={{ margin: 0, fontSize: '1.2rem' }}>День {activeDay}</h2>
        </div>

        {/* Тема дня */}
        <div style={{ ...S.card('#1a2040'), marginBottom: '0.8rem', borderLeft: '3px solid c.accent' }}>
          <div style={S.tag('c.accent')}>Тема дня</div>
          <p style={{ margin: '6px 0 0', fontSize: '1.2rem', fontWeight: 700, lineHeight: 1.4 }}>{dayData.theme}</p>
        </div>

        {/* Мини-урок */}
        <div style={{ ...S.card('#141420'), marginBottom: '1.2rem', border: '1px solid #2a2a4a', cursor: 'pointer' }}
          onClick={() => setLessonOpen(o => !o)}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <span style={{ fontSize: '1.1rem' }}>📖</span>
              <span style={{ fontSize: '0.9rem', fontWeight: 700, color: '#a78bfa' }}>Мини-урок</span>
            </div>
            <span style={{ color: c.textSec, fontSize: '1rem', transition: 'transform 0.2s', display: 'inline-block', transform: lessonOpen ? 'rotate(90deg)' : 'rotate(0deg)' }}>›</span>
          </div>
          {lessonOpen && (
            <p style={{ margin: '0.8rem 0 0', fontSize: '0.92rem', color: c.textSec, lineHeight: 1.7 }}>
              {dayData.lesson}
            </p>
          )}
        </div>

        {/* 3 задания */}
        {dayData.tasks.map((task, i) => {
          const done = isTaskDone(userState.journalEntries, activeDay, i);
          const entries = userState.journalEntries.filter(e => e.day === activeDay && e.taskIdx === i);
          const isNewBlocked = false; // ограничения сняты

          return (
            <div key={i} style={{ ...S.card(done ? '#1a2e1a' : '#1e1e2a'), border: `1px solid ${done ? '#2a4a2a' : '#2a2a3a'}`, marginBottom: '0.8rem' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: 8 }}>
                <div style={{ flex: 1 }}>
                  <div style={{ display: 'flex', gap: 6, marginBottom: 6, alignItems: 'center' }}>
                    <span style={S.tag(done ? 'c.success' : i === 0 ? '#2d5a9e' : i === 1 ? '#5a3a8a' : '#3a5a3a')}>
                      {done ? '✓ ' : ''}{taskLabels[i]}
                    </span>
                  </div>
                  <p style={{ margin: 0, fontSize: '0.95rem', lineHeight: 1.5, color: done ? '#aaa' : '#eee' }}>{task}</p>
                </div>
              </div>

              {/* Записи по этому заданию */}
              {entries.length > 0 && (
                <div style={{ marginTop: '0.8rem', borderTop: '1px solid #2a2a3a', paddingTop: '0.8rem' }}>
                  {entries.map(e => (
                    <div key={e.id} style={{ fontSize: '0.88rem', color: c.textSec, marginBottom: 4 }}>
                      <span style={{ color: c.textSec, fontSize: '0.75rem' }}>{e.date} · </span>{e.text}
                    </div>
                  ))}
                </div>
              )}

              {/* Кнопка */}
              <button
                disabled={isNewBlocked}
                onClick={() => { if (!isNewBlocked) openTaskJournal(activeDay, i); }}
                style={{ ...S.btn(done ? '#2e5c2e' : isNewBlocked ? '#1a1a1a' : '#2d5a9e'), marginTop: '0.8rem', marginBottom: 0, opacity: isNewBlocked ? 0.4 : 1, cursor: isNewBlocked ? 'not-allowed' : 'pointer', fontSize: '0.9rem', padding: '0.6rem 1rem' }}>
                {done ? '📝 Дописать' : isNewBlocked ? '🔒 Завтра' : '✍️ Написать'}
              </button>
            </div>
          );
        })}

        {/* Итоговый прогресс */}
        <div style={{ ...S.card('#111'), textAlign: 'center', marginTop: '0.5rem' }}>
          <div style={{ display: 'flex', gap: 6, justifyContent: 'center', marginBottom: 8 }}>
            {[0, 1, 2].map(i => (
              <div key={i} style={{ width: 40, height: 6, borderRadius: 3, background: isTaskDone(userState.journalEntries, activeDay, i) ? 'c.success' : '#2a2a2a' }} />
            ))}
          </div>
          <p style={{ margin: 0, fontSize: '0.85rem', color: isDayDone ? 'c.success' : '#666' }}>
            {isDayDone ? '✓ День полностью выполнен!' : `Выполнено ${dayProgress(userState.journalEntries, activeDay)} из 3 заданий`}
          </p>
        </div>

        <button style={{ ...S.btn('#333'), marginTop: '1rem' }} onClick={() => setScreen('plan')}>← К плану</button>
      </div>
    );
  }

  // ════════════════════════════════════════════════════════════════════════════
  // TASK JOURNAL — написать запись к заданию
  // ════════════════════════════════════════════════════════════════════════════
  if (screen === 'task-journal') {
    const dayData = dailyPlan[activeDay - 1];
    const taskText = dayData.tasks[activeTaskIdx];
    const taskLabels = ['🔵 Практика', '👁 Наблюдение', '✍️ Рефлексия'];
    const prevEntries = userState.journalEntries.filter(e => e.day === activeDay && e.taskIdx === activeTaskIdx);
    const canSave = taskDraft.trim().length > 0;

    const c = getColors(userState.theme === 'dark');

    return (
      <div style={{ minHeight: '100vh', background: c.bg, color: c.text, padding: '1.5rem', fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' }}>
        <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
          <button style={{ background: 'none', border: 'none', color: c.textSec, cursor: 'pointer', fontSize: '1.2rem', marginRight: 8 }} onClick={() => setScreen('day-detail')}>←</button>
          <h2 style={{ margin: 0, fontSize: '1.1rem' }}>День {activeDay} · {taskLabels[activeTaskIdx]}</h2>
        </div>

        <div style={{ ...S.card('#1a2040'), marginBottom: '1.2rem', borderLeft: '3px solid c.accent' }}>
          <div style={S.tag('c.accent')}>{taskLabels[activeTaskIdx]}</div>
          <p style={{ margin: '6px 0 0', fontSize: '1rem', lineHeight: 1.5 }}>{taskText}</p>
        </div>

        {prevEntries.length > 0 && (
          <div style={{ marginBottom: '1rem' }}>
            <p style={{ color: c.textSec, fontSize: '0.85rem', margin: '0 0 8px' }}>Предыдущие записи:</p>
            {prevEntries.map(e => (
              <div key={e.id} style={{ ...S.card('#1e1e1e'), fontSize: '0.9rem' }}>
                <div style={{ color: c.textSec, fontSize: '0.75rem', marginBottom: 4 }}>{e.date}</div>
                {e.text}
              </div>
            ))}
          </div>
        )}

        <p style={{ color: c.textSec, fontSize: '0.95rem', margin: '0 0 8px' }}>Опиши честно — что произошло, что почувствовал?</p>
        <textarea value={taskDraft} onChange={e => setTaskDraft(e.target.value)}
          placeholder="Пиши честно — это только для тебя..."
          style={{ width: '100%', minHeight: '140px', padding: '1rem', background: c.card, color: c.text, border: `1px solid ${canSave ? 'c.accent55' : '#333'}`, borderRadius: '14px', marginBottom: '1rem', fontSize: '1rem', lineHeight: 1.5, resize: 'vertical', boxSizing: 'border-box' }} />

        <button style={{ ...S.btn(canSave ? 'c.success' : '#333'), opacity: canSave ? 1 : 0.5, cursor: canSave ? 'pointer' : 'not-allowed' }}
          disabled={!canSave} onClick={saveTaskEntry}>
          💾 Сохранить запись
        </button>
        <button style={{ background: c.buttonSecondaryBg, color: c.buttonSecondaryText, border: `1px solid ${c.border}`, padding: '1rem', fontSize: '1rem', borderRadius: '12px', cursor: 'pointer', width: '100%', marginBottom: '0.7rem', fontWeight: 600, letterSpacing: '-0.01em' }} onClick={() => setScreen('day-detail')}>← Назад</button>
        <p style={{ fontSize: '0.8rem', color: c.textSec, textAlign: 'center', marginTop: 4 }}>
          День закроется, когда все 3 задания будут с записями
        </p>
      </div>
    );
  }

  // ════════════════════════════════════════════════════════════════════════════
  // JOURNAL
  // ════════════════════════════════════════════════════════════════════════════
  if (screen === 'journal') {
    const freeEntries = userState.journalEntries.filter(e => !e.day);
    const taskEntries = userState.journalEntries.filter(e => e.day);

    const c = getColors(userState.theme === 'dark');

    return (
      <div style={{ minHeight: '100vh', background: c.bg, color: c.text, padding: '1.5rem', fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' }}>
        <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
          <button style={{ background: 'none', border: 'none', color: c.textSec, cursor: 'pointer', fontSize: '1.2rem', marginRight: 8 }} onClick={() => setScreen('home')}>←</button>
          <h1 style={{ margin: 0, fontSize: '1.5rem' }}>Журнал записей</h1>
        </div>

        <textarea value={journalDraft} onChange={e => setJournalDraft(e.target.value)}
          placeholder="Что ты чувствуешь сегодня? Что хочешь изменить?"
          style={{ width: '100%', minHeight: '110px', padding: '1rem', background: c.buttonSecondaryBg, color: c.buttonSecondaryText, border: `1px solid ${c.border}`, borderRadius: '14px', marginBottom: '0.8rem', fontSize: '1rem', lineHeight: 1.5, resize: 'vertical', boxSizing: 'border-box' }} />
        <button style={{ ...S.btn(journalDraft.trim() ? 'c.accent' : '#333'), opacity: journalDraft.trim() ? 1 : 0.5 }}
          disabled={!journalDraft.trim()} onClick={saveFreeEntry}>
          💾 Сохранить запись
        </button>

        {freeEntries.length > 0 && (
          <>
            <h2 style={{ fontSize: '1.1rem', color: c.textSec, margin: '1.5rem 0 0.5rem' }}>Свободные записи</h2>
            {[...freeEntries].reverse().map(e => (
              <div key={e.id} style={{ ...S.card('#1e1e1e'), position: 'relative' }}>
                <div style={{ color: c.textSec, fontSize: '0.75rem', marginBottom: 4 }}>{e.date}</div>
                <p style={{ margin: 0, lineHeight: 1.5 }}>{e.text}</p>
                <button style={{ position: 'absolute', top: 8, right: 10, background: 'none', border: 'none', color: c.textSec, cursor: 'pointer', fontSize: '1rem' }} onClick={() => deleteEntry(e.id)}>✕</button>
              </div>
            ))}
          </>
        )}

        {taskEntries.length > 0 && (
          <>
            <h2 style={{ fontSize: '1.1rem', color: c.textSec, margin: '1.5rem 0 0.5rem' }}>Записи по заданиям</h2>
            {[...taskEntries].reverse().map(e => (
              <div key={e.id} style={{ ...S.card('#1a2040'), position: 'relative' }}>
                <div style={{ display: 'flex', gap: 8, marginBottom: 4, alignItems: 'center', flexWrap: 'wrap' }}>
                  <span style={S.tag('c.accent')}>День {e.day}</span>
                  <span style={S.tag(e.taskIdx === 0 ? '#2d5a9e' : e.taskIdx === 1 ? '#5a3a8a' : '#3a5a3a')}>
                    {e.taskIdx === 0 ? '🔵 Практика' : e.taskIdx === 1 ? '👁 Наблюдение' : '✍️ Рефлексия'}
                  </span>
                  <span style={{ color: c.textSec, fontSize: '0.75rem' }}>{e.date}</span>
                </div>
                <p style={{ margin: 0, lineHeight: 1.5 }}>{e.text}</p>
                <button style={{ position: 'absolute', top: 8, right: 10, background: 'none', border: 'none', color: c.textSec, cursor: 'pointer', fontSize: '1rem' }} onClick={() => deleteEntry(e.id)}>✕</button>
              </div>
            ))}
          </>
        )}

        {userState.journalEntries.length === 0 && (
          <p style={{ color: c.textSec, textAlign: 'center', marginTop: '2rem' }}>Пока пусто — начни писать!</p>
        )}

        <button style={{ ...S.btn('#222'), marginTop: '1rem' }} onClick={() => setScreen('home')}>На главную</button>

        <div style={{ marginTop: '2rem', borderTop: '1px solid #1e1e1e', paddingTop: '1.5rem' }}>
          {!resetConfirm ? (
            <button style={{ ...S.btn('#1a1a1a'), color: c.textSec, border: '1px solid #2a2a2a' }} onClick={() => setResetConfirm(true)}>
              🗑 Сбросить весь прогресс
            </button>
          ) : (
            <div style={{ ...S.card('#2a1010'), border: '1px solid #ff444433', textAlign: 'center' }}>
              <p style={{ margin: '0 0 1rem', fontSize: '0.95rem', color: '#ff8888' }}>⚠️ Это удалит весь прогресс, записи и результат теста. Действие необратимо.</p>
              <div style={{ display: 'flex', gap: '0.75rem' }}>
                <button style={{ ...S.btn('#ff3333'), marginBottom: 0, flex: 1 }} onClick={resetAll}>Да, сбросить</button>
                <button style={{ ...S.btn('#333'), marginBottom: 0, flex: 1 }} onClick={() => setResetConfirm(false)}>Отмена</button>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  // ════════════════════════════════════════════════════════════════════════════
  // STATS
  // ════════════════════════════════════════════════════════════════════════════
  if (screen === 'stats') {
    const c = getColors(userState.theme === 'dark');
    const totalDays = userState.completedDays.length;
    const totalEntries = userState.journalEntries.length;
    const taskEntries = userState.journalEntries.filter(e => e.day !== undefined);
    const freeEntries = userState.journalEntries.filter(e => e.day === undefined);
    const totalWords = userState.journalEntries.reduce((acc, e) => acc + e.text.split(/\s+/).filter(Boolean).length, 0);
    const unlocked = getUnlockedAchievements(userState).length;

    // Активность по неделям (последние 12 недель)
    const weeklyData: { week: string; count: number }[] = [];
    for (let w = 11; w >= 0; w--) {
      const weekStart = new Date();
      weekStart.setDate(weekStart.getDate() - weekStart.getDay() - w * 7);
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);
      const label = `${weekStart.getDate()}.${String(weekStart.getMonth() + 1).padStart(2, '0')}`;
      // Считаем записи за эту неделю
      const count = userState.journalEntries.filter(e => {
        const parts = e.date.split(', ');
        if (!parts[0]) return false;
        const [d, m, y] = parts[0].split('.');
        if (!d || !m || !y) return false;
        const entryDate = new Date(+('20' + y.slice(-2)), +m - 1, +d);
        return entryDate >= weekStart && entryDate <= weekEnd;
      }).length;
      weeklyData.push({ week: label, count });
    }
    const maxWeekCount = Math.max(...weeklyData.map(w => w.count), 1);

    // Распределение по типам заданий
    const practiceCount = taskEntries.filter(e => e.taskIdx === 0).length;
    const observeCount  = taskEntries.filter(e => e.taskIdx === 1).length;
    const reflectCount  = taskEntries.filter(e => e.taskIdx === 2).length;

    // Средняя длина записи
    const avgWords = totalEntries > 0 ? Math.round(totalWords / totalEntries) : 0;

    // Самый продуктивный день недели
    const dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
    const byDayOfWeek = [0, 0, 0, 0, 0, 0, 0];
    userState.journalEntries.forEach(e => {
      const parts = e.date.split(', ');
      if (!parts[0]) return;
      const [d, m, y] = parts[0].split('.');
      if (!d || !m || !y) return;
      const date = new Date(+('20' + y.slice(-2)), +m - 1, +d);
      byDayOfWeek[date.getDay()]++;
    });
    const maxDayIdx = byDayOfWeek.indexOf(Math.max(...byDayOfWeek));
    const bestDay = byDayOfWeek[maxDayIdx] > 0 ? dayNames[maxDayIdx] : '—';


    return (
      <div style={{ minHeight: '100vh', background: c.bg, color: c.text, padding: '1.5rem', fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' }}>
        <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
          <button style={{ background: 'none', border: 'none', color: c.textSec, cursor: 'pointer', fontSize: '1.2rem', marginRight: 8 }} onClick={() => setScreen('home')}>←</button>
          <h1 style={{ margin: 0, fontSize: '1.5rem' }}>Статистика</h1>
        </div>

        {/* Ключевые цифры — 2×2 */}
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.7rem', marginBottom: '1rem' }}>
          {[
            { emoji: '✅', value: totalDays, label: 'дней выполнено', color: 'c.success' },
            { emoji: '📝', value: totalEntries, label: 'записей всего', color: c.accent },
            { emoji: '🔥', value: userState.maxStreak, label: 'рекорд стрика', color: '#ff8c42' },
            { emoji: '🏅', value: unlocked, label: `ачивок из ${ACHIEVEMENTS.length}`, color: '#a855f7' },
          ].map(({ emoji, value, label, color }) => (
            <div key={label} style={{ background: c.card, borderRadius: '14px', padding: '1rem', textAlign: 'center', border: `1px solid ${color}22` }}>
              <div style={{ fontSize: '1.6rem', marginBottom: 4 }}>{emoji}</div>
              <div style={{ fontSize: '2rem', fontWeight: 800, color, lineHeight: 1 }}>{value}</div>
              <div style={{ fontSize: '0.72rem', color: c.textSec, marginTop: 4 }}>{label}</div>
            </div>
          ))}
        </div>

        {/* Доп. метрики */}
        <div style={{ ...S.card('#1a1a1a'), marginBottom: '1rem' }}>
          <p style={{ margin: '0 0 0.8rem', fontWeight: 700, fontSize: '0.9rem', color: c.textSec, letterSpacing: '0.05em' }}>ДЕТАЛИ</p>
          {[
            { label: '📖 Слов написано', value: totalWords.toLocaleString('ru-RU') },
            { label: '✍️ Средняя длина записи', value: `${avgWords} слов` },
            { label: '🗓 Лучший день недели', value: bestDay },
            { label: '📓 Свободных записей', value: freeEntries.length },
            { label: '🎯 Записей по заданиям', value: taskEntries.length },
            { label: '📈 Прогресс плана', value: `${Math.round((totalDays / 90) * 100)}%` },
          ].map(({ label, value }) => (
            <div key={label} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.5rem 0', borderBottom: '1px solid #222' }}>
              <span style={{ fontSize: '0.9rem', color: c.textSec }}>{label}</span>
              <span style={{ fontSize: '0.95rem', fontWeight: 700, color: c.text }}>{value}</span>
            </div>
          ))}
        </div>

        {/* Распределение по типам */}
        {taskEntries.length > 0 && (
          <div style={{ ...S.card('#1a1a1a'), marginBottom: '1rem' }}>
            <p style={{ margin: '0 0 0.8rem', fontWeight: 700, fontSize: '0.9rem', color: c.textSec, letterSpacing: '0.05em' }}>ТИП ЗАПИСЕЙ</p>
            {[
              { label: '🔵 Практика', count: practiceCount, color: '#2d5a9e' },
              { label: '👁 Наблюдение', count: observeCount, color: '#5a3a8a' },
              { label: '✍️ Рефлексия', count: reflectCount, color: '#3a5a3a' },
            ].map(({ label, count, color }) => {
              const pct = taskEntries.length > 0 ? Math.round((count / taskEntries.length) * 100) : 0;
              return (
                <div key={label} style={{ marginBottom: '0.7rem' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                    <span style={{ fontSize: '0.85rem', color: c.textSec }}>{label}</span>
                    <span style={{ fontSize: '0.85rem', color: c.textSec }}>{count} · {pct}%</span>
                  </div>
                  <div style={{ background: c.card, borderRadius: 4, height: 6 }}>
                    <div style={{ background: color, width: `${pct}%`, height: 6, borderRadius: 4, minWidth: count > 0 ? 6 : 0 }} />
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {/* График активности по неделям */}
        {totalEntries > 0 && (
          <div style={{ ...S.card('#1a1a1a'), marginBottom: '1rem' }}>
            <p style={{ margin: '0 0 1rem', fontWeight: 700, fontSize: '0.9rem', color: c.textSec, letterSpacing: '0.05em' }}>АКТИВНОСТЬ ПО НЕДЕЛЯМ</p>
            <div style={{ display: 'flex', alignItems: 'flex-end', gap: '4px', height: '80px' }}>
              {weeklyData.map(({ week, count }) => (
                <div key={week} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 4 }}>
                  <div style={{ width: '100%', background: count > 0 ? 'c.accent' : '#222', borderRadius: '3px 3px 0 0', height: `${Math.round((count / maxWeekCount) * 64) + (count > 0 ? 4 : 0)}px`, minHeight: count > 0 ? 8 : 4, transition: 'height 0.3s' }} />
                  <span style={{ fontSize: '0.55rem', color: c.textSec, whiteSpace: 'nowrap' }}>{week}</span>
                </div>
              ))}
            </div>
          </div>
        )}

        {totalEntries === 0 && (
          <div style={{ textAlign: 'center', padding: '2rem 0', color: c.textSec }}>
            <div style={{ fontSize: '3rem', marginBottom: '0.5rem' }}>📊</div>
            <p style={{ margin: 0 }}>Пока данных нет — начни выполнять задания!</p>
          </div>
        )}

        <button style={{ ...S.btn('#333'), marginTop: '0.5rem' }} onClick={() => setScreen('home')}>На главную</button>
      </div>
    );
  }

  // ════════════════════════════════════════════════════════════════════════════
  // PLANNER
  // ════════════════════════════════════════════════════════════════════════════
  if (screen === 'planner') {
    const todayTasks = userState.dailyTasks;
    const doneTasks = todayTasks.filter(t => t.done).length;
    const weekGoals = userState.weeklyGoals;
    const doneGoals = weekGoals.filter(g => g.done).length;

    // Интеграция с 90-дневным планом
    const dayData = dailyPlan[userState.currentDay - 1];
    const planTasks = dayData ? dayData.tasks : [];

    function addDailyTask() {
      if (!taskDraftPlanner.trim()) return;
      const task: DailyTask = {
        id: Date.now().toString(),
        text: taskDraftPlanner.trim(),
        done: false,
        priority: taskPriority,
        time: taskTime || undefined,
      };
      updateState({ dailyTasks: [...userState.dailyTasks, task] });
      setTaskDraftPlanner('');
      setTaskTime('');
      setTaskPriority('medium');
    }

    function toggleTask(id: string) {
      updateState({
        dailyTasks: userState.dailyTasks.map(t => t.id === id ? { ...t, done: !t.done } : t)
      });
    }

    function deleteTask(id: string) {
      updateState({ dailyTasks: userState.dailyTasks.filter(t => t.id !== id) });
    }

    function addWeekGoal() {
      if (!weekGoalDraft.trim()) return;
      const goal: WeeklyGoal = {
        id: Date.now().toString(),
        text: weekGoalDraft.trim(),
        done: false,
      };
      updateState({ weeklyGoals: [...userState.weeklyGoals, goal] });
      setWeekGoalDraft('');
    }

    function toggleGoal(id: string) {
      updateState({
        weeklyGoals: userState.weeklyGoals.map(g => g.id === id ? { ...g, done: !g.done } : g)
      });
    }

    function deleteGoal(id: string) {
      updateState({ weeklyGoals: userState.weeklyGoals.filter(g => g.id !== id) });
    }

    const priorityColors = { high: '#ff4444', medium: '#ff9800', low: 'c.success' };
    const priorityLabels = { high: '🔴 Важно', medium: '🟡 Средне', low: '🟢 Низко' };

    const c = getColors(userState.theme === 'dark');
    return (
      <div style={{ minHeight: '100vh', background: c.bg, color: c.text, padding: '1.5rem', fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif' }}>
        <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
          <button style={{ background: 'none', border: 'none', color: c.textSec, cursor: 'pointer', fontSize: '1.2rem', marginRight: 8 }} onClick={() => setScreen('home')}>←</button>
          <h1 style={{ margin: 0, fontSize: '1.5rem' }}>Планирование</h1>
        </div>

        {/* Табы */}
        <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1.2rem' }}>
          <button
            onClick={() => setPlannerTab('day')}
            style={{
              flex: 1,
              background: plannerTab === 'day' ? '#2d5a9e' : '#1a1a1a',
              color: c.text,
              border: 'none',
              padding: '0.8rem',
              borderRadius: '12px',
              cursor: 'pointer',
              fontWeight: 700,
              fontSize: '0.95rem',
            }}>
            📋 День
          </button>
          <button
            onClick={() => setPlannerTab('week')}
            style={{
              flex: 1,
              background: plannerTab === 'week' ? '#2d5a9e' : '#1a1a1a',
              color: c.text,
              border: 'none',
              padding: '0.8rem',
              borderRadius: '12px',
              cursor: 'pointer',
              fontWeight: 700,
              fontSize: '0.95rem',
            }}>
            📅 Неделя
          </button>
        </div>

        {/* TAB: ДЕНЬ */}
        {plannerTab === 'day' && (
          <>
            {/* Интеграция с 90-дневным планом */}
            {dayData && (
              <div style={{ ...S.card('#1a2040'), marginBottom: '1rem', borderLeft: '3px solid c.accent' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 6 }}>
                  <span style={S.tag('c.accent')}>День {userState.currentDay} · {dayData.theme}</span>
                  <button
                    onClick={() => setScreen('day-detail')}
                    style={{ background: 'none', border: 'none', color: c.accent, cursor: 'pointer', fontSize: '0.85rem', fontWeight: 600 }}>
                    Открыть →
                  </button>
                </div>
                <p style={{ margin: '4px 0 0', fontSize: '0.85rem', color: c.textSec }}>
                  3 задания по плану: {planTasks.map((_, i) => isTaskDone(userState.journalEntries, userState.currentDay, i) ? '✓' : '○').join(' ')}
                </p>
              </div>
            )}

            {/* Прогресс дня */}
            {todayTasks.length > 0 && (
              <div style={{ ...S.card('#1a1a2a'), marginBottom: '1rem', textAlign: 'center' }}>
                <p style={{ margin: '0 0 8px', fontWeight: 700, fontSize: '1rem' }}>
                  {doneTasks} <span style={{ color: c.textSec, fontWeight: 400 }}>из</span> {todayTasks.length}
                </p>
                <div style={{ background: c.card, borderRadius: 8, height: 8 }}>
                  <div style={{ background: 'c.success', width: `${Math.round((doneTasks / todayTasks.length) * 100)}%`, height: 8, borderRadius: 8, transition: 'width 0.3s', minWidth: doneTasks > 0 ? 8 : 0 }} />
                </div>
              </div>
            )}

            {/* Добавить задачу */}
            <div style={{ ...S.card('#1a1a1a'), marginBottom: '1rem' }}>
              <p style={{ margin: '0 0 8px', fontSize: '0.9rem', fontWeight: 700, color: c.textSec }}>НОВАЯ ЗАДАЧА</p>
              <input
                value={taskDraftPlanner}
                onChange={e => setTaskDraftPlanner(e.target.value)}
                placeholder="Что нужно сделать?"
                style={{ width: '100%', padding: '0.8rem', background: c.bg, color: c.text, border: `1px solid ${c.border}`, borderRadius: '10px', marginBottom: '0.8rem', fontSize: '0.95rem', boxSizing: 'border-box' }}
              />
              <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.8rem' }}>
                <input
                  type="time"
                  value={taskTime}
                  onChange={e => setTaskTime(e.target.value)}
                  style={{ flex: 1, padding: '0.7rem', background: c.bg, color: c.text, border: `1px solid ${c.border}`, borderRadius: '10px', fontSize: '0.9rem' }}
                />
                <select
                  value={taskPriority}
                  onChange={e => setTaskPriority(e.target.value as any)}
                  style={{ flex: 1, padding: '0.7rem', background: c.bg, color: c.text, border: `1px solid ${c.border}`, borderRadius: '10px', fontSize: '0.9rem' }}>
                  <option value="high">🔴 Важно</option>
                  <option value="medium">🟡 Средне</option>
                  <option value="low">🟢 Низко</option>
                </select>
              </div>
              <button
                onClick={addDailyTask}
                disabled={!taskDraftPlanner.trim()}
                style={{ ...S.btn(taskDraftPlanner.trim() ? 'c.success' : '#333'), marginBottom: 0, opacity: taskDraftPlanner.trim() ? 1 : 0.5, cursor: taskDraftPlanner.trim() ? 'pointer' : 'not-allowed', fontSize: '0.9rem', padding: '0.7rem' }}>
                ✚ Добавить задачу
              </button>
            </div>

            {/* Список задач */}
            {todayTasks.length > 0 ? (
              todayTasks.map(task => (
                <div key={task.id} style={{ ...S.card(task.done ? '#1a2e1a' : '#1e1e1e'), marginBottom: '0.6rem', border: `1px solid ${task.done ? '#2a4a2a' : priorityColors[task.priority]}44` }}>
                  <div style={{ display: 'flex', alignItems: 'flex-start', gap: '0.8rem' }}>
                    <input
                      type="checkbox"
                      checked={task.done}
                      onChange={() => toggleTask(task.id)}
                      style={{ width: 20, height: 20, cursor: 'pointer', marginTop: 2, flexShrink: 0 }}
                    />
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <div style={{ display: 'flex', gap: 6, marginBottom: 4, flexWrap: 'wrap' }}>
                        {task.time && <span style={S.tag('#2d5a9e')}>{task.time}</span>}
                        <span style={S.tag(priorityColors[task.priority])}>{priorityLabels[task.priority]}</span>
                      </div>
                      <p style={{ margin: 0, fontSize: '0.95rem', textDecoration: task.done ? 'line-through' : 'none', color: task.done ? '#666' : '#eee' }}>
                        {task.text}
                      </p>
                    </div>
                    <button
                      onClick={() => deleteTask(task.id)}
                      style={{ background: 'none', border: 'none', color: c.textSec, cursor: 'pointer', fontSize: '1rem', flexShrink: 0 }}>
                      ✕
                    </button>
                  </div>
                </div>
              ))
            ) : (
              <div style={{ textAlign: 'center', padding: '2rem 0', color: c.textSec }}>
                <div style={{ fontSize: '3rem', marginBottom: '0.5rem' }}>📋</div>
                <p style={{ margin: 0 }}>Добавь задачи на сегодня</p>
              </div>
            )}
          </>
        )}

        {/* TAB: НЕДЕЛЯ */}
        {plannerTab === 'week' && (
          <>
            {/* Прогресс недели */}
            {weekGoals.length > 0 && (
              <div style={{ ...S.card('#1a1a2a'), marginBottom: '1rem', textAlign: 'center' }}>
                <p style={{ margin: '0 0 8px', fontWeight: 700, fontSize: '1rem' }}>
                  {doneGoals} <span style={{ color: c.textSec, fontWeight: 400 }}>из</span> {weekGoals.length}
                </p>
                <div style={{ background: c.card, borderRadius: 8, height: 8 }}>
                  <div style={{ background: c.accent, width: `${Math.round((doneGoals / weekGoals.length) * 100)}%`, height: 8, borderRadius: 8, transition: 'width 0.3s', minWidth: doneGoals > 0 ? 8 : 0 }} />
                </div>
              </div>
            )}

            {/* Добавить цель */}
            <div style={{ ...S.card('#1a1a1a'), marginBottom: '1rem' }}>
              <p style={{ margin: '0 0 8px', fontSize: '0.9rem', fontWeight: 700, color: c.textSec }}>НОВАЯ ЦЕЛЬ НА НЕДЕЛЮ</p>
              <input
                value={weekGoalDraft}
                onChange={e => setWeekGoalDraft(e.target.value)}
                placeholder="Что хочу достичь на этой неделе?"
                style={{ width: '100%', padding: '0.8rem', background: c.bg, color: c.text, border: `1px solid ${c.border}`, borderRadius: '10px', marginBottom: '0.8rem', fontSize: '0.95rem', boxSizing: 'border-box' }}
              />
              <button
                onClick={addWeekGoal}
                disabled={!weekGoalDraft.trim()}
                style={{ ...S.btn(weekGoalDraft.trim() ? 'c.accent' : '#333'), marginBottom: 0, opacity: weekGoalDraft.trim() ? 1 : 0.5, cursor: weekGoalDraft.trim() ? 'pointer' : 'not-allowed', fontSize: '0.9rem', padding: '0.7rem' }}>
                ✚ Добавить цель
              </button>
            </div>

            {/* Список целей */}
            {weekGoals.length > 0 ? (
              weekGoals.map(goal => (
                <div key={goal.id} style={{ ...S.card(goal.done ? '#1a2a40' : '#1e1e1e'), marginBottom: '0.6rem', border: `1px solid ${goal.done ? '#2a4a6a' : '#2a2a3a'}` }}>
                  <div style={{ display: 'flex', alignItems: 'flex-start', gap: '0.8rem' }}>
                    <input
                      type="checkbox"
                      checked={goal.done}
                      onChange={() => toggleGoal(goal.id)}
                      style={{ width: 20, height: 20, cursor: 'pointer', marginTop: 2, flexShrink: 0 }}
                    />
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <p style={{ margin: 0, fontSize: '0.95rem', textDecoration: goal.done ? 'line-through' : 'none', color: goal.done ? '#666' : '#eee' }}>
                        {goal.text}
                      </p>
                    </div>
                    <button
                      onClick={() => deleteGoal(goal.id)}
                      style={{ background: 'none', border: 'none', color: c.textSec, cursor: 'pointer', fontSize: '1rem', flexShrink: 0 }}>
                      ✕
                    </button>
                  </div>
                </div>
              ))
            ) : (
              <div style={{ textAlign: 'center', padding: '2rem 0', color: c.textSec }}>
                <div style={{ fontSize: '3rem', marginBottom: '0.5rem' }}>📅</div>
                <p style={{ margin: 0 }}>Поставь цели на неделю</p>
              </div>
            )}
          </>
        )}

        <button style={{ ...S.btn('#333'), marginTop: '1rem' }} onClick={() => setScreen('home')}>На главную</button>
      </div>
    );
  }

  return null;
}

const globalStyle = document.createElement('style');
globalStyle.textContent = `
  *, *::before, *::after { box-sizing: border-box; }
  html, body { margin: 0; padding: 0; overflow-x: hidden; max-width: 100vw; }
  body { display: flex; justify-content: center; align-items: flex-start; }
  #root { max-width: 480px; width: 100%; margin: 0 auto; }
  img { max-width: 100%; }
  textarea { max-width: 100%; }
`;
if (!document.head.querySelector('[data-app-style]')) {
  globalStyle.setAttribute('data-app-style', '1');
  document.head.appendChild(globalStyle);
}